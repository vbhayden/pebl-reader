let DEBUGGING=false;function consoleLog(...x) { if (DEBUGGING) { console.log(...x); } }; function consoleError(...x) { if (DEBUGGING) { console.error(...x); } }
var requirejs,require,define;!function(e){function t(e,t){return w.call(e,t)}function n(e,t){var n,i,r,a,o,s,l,c,f,u,d,_,h=t&&t.split("/"),p=b.map,v=p&&p["*"]||{};if(e){for(e=e.split("/"),o=e.length-1,b.nodeIdCompat&&y.test(e[o])&&(e[o]=e[o].replace(y,"")),"."===e[0].charAt(0)&&h&&(_=h.slice(0,h.length-1),e=_.concat(e)),f=0;f<e.length;f++)if("."===(d=e[f]))e.splice(f,1),f-=1;else if(".."===d){if(0===f||1===f&&".."===e[2]||".."===e[f-1])continue;f>0&&(e.splice(f-1,2),f-=2)}e=e.join("/")}if((h||v)&&p){for(n=e.split("/"),f=n.length;f>0;f-=1){if(i=n.slice(0,f).join("/"),h)for(u=h.length;u>0;u-=1)if((r=p[h.slice(0,u).join("/")])&&(r=r[i])){a=r,s=f;break}if(a)break;!l&&v&&v[i]&&(l=v[i],c=f)}!a&&l&&(a=l,s=c),a&&(n.splice(0,s,a),e=n.join("/"))}return e}function i(t,n){return function(){var i=g.call(arguments,0);return"string"!=typeof i[0]&&1===i.length&&i.push(null),u.apply(e,i.concat([t,n]))}}function r(e){return function(t){return n(t,e)}}function a(e){return function(t){h[e]=t}}function o(n){if(t(p,n)){var i=p[n];delete p[n],v[n]=!0,f.apply(e,i)}if(!t(h,n)&&!t(v,n))throw new Error("No "+n);return h[n]}function s(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function l(e){return e?s(e):[]}function c(e){return function(){return b&&b.config&&b.config[e]||{}}}var f,u,d,_,h={},p={},b={},v={},w=Object.prototype.hasOwnProperty,g=[].slice,y=/\.js$/;d=function(e,t){var i,a=s(e),l=a[0],c=t[1];return e=a[1],l&&(l=n(l,c),i=o(l)),l?e=i&&i.normalize?i.normalize(e,r(c)):n(e,c):(e=n(e,c),a=s(e),l=a[0],e=a[1],l&&(i=o(l))),{f:l?l+"!"+e:e,n:e,pr:l,p:i}},_={require:function(e){return i(e)},exports:function(e){var t=h[e];return void 0!==t?t:h[e]={}},module:function(e){return{id:e,uri:"",exports:h[e],config:c(e)}}},f=function(n,r,s,c){var f,u,b,w,g,y,m,x=[],k=typeof s;if(c=c||n,y=l(c),"undefined"===k||"function"===k){for(r=!r.length&&s.length?["require","exports","module"]:r,g=0;g<r.length;g+=1)if(w=d(r[g],y),"require"===(u=w.f))x[g]=_.require(n);else if("exports"===u)x[g]=_.exports(n),m=!0;else if("module"===u)f=x[g]=_.module(n);else if(t(h,u)||t(p,u)||t(v,u))x[g]=o(u);else{if(!w.p)throw new Error(n+" missing "+u);w.p.load(w.n,i(c,!0),a(u),{}),x[g]=h[u]}b=s?s.apply(h[n],x):void 0,n&&(f&&f.exports!==e&&f.exports!==h[n]?h[n]=f.exports:b===e&&m||(h[n]=b))}else n&&(h[n]=s)},requirejs=require=u=function(t,n,i,r,a){if("string"==typeof t)return _[t]?_[t](n):o(d(t,l(n)).f);if(!t.splice){if(b=t,b.deps&&u(b.deps,b.callback),!n)return;n.splice?(t=n,n=i,i=null):t=e}return n=n||function(){},"function"==typeof i&&(i=r,r=a),r?f(e,t,n,i):setTimeout(function(){f(e,t,n,i)},4),u},u.config=function(e){return u(e)},requirejs._defined=h,define=function(e,n,i){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");n.splice||(i=n,n=[]),t(h,e)||t(p,e)||(p[e]=[e,n,i])},define.amd={jQuery:!0}}(),define("readium-js-viewer_CLOUDAPP-WORKER",function(){});var currentURL=self.location?self.location.protocol+"//"+self.location.hostname+(self.location.port?":"+self.location.port:"")+(self.location.pathname?self.location.pathname:""):"";console.log(currentURL),console.log(self.location.origin),require.config({waitSeconds:0,config:{"readium_js_viewer/ModuleConfig":{mathJaxUrl:self.location.origin+"/scripts/mathjax/MathJax.js",fonts:[],annotationCSSUrl:self.location.origin+"/css/annotations.css",jsLibRoot:"/scripts/zip/",useSimpleLoader:!0,epubLibraryPath:void 0,imagePathPrefix:void 0,canHandleUrl:!1,canHandleDirectory:!0,workerUrl:"/scripts/readium-js-viewer_CLOUD-WORKER.js",epubReadingSystemUrl:self.location.origin+"/scripts/epubReadingSystem.js"}}}),define("readium_js_viewer_RJS-CONFIG",function(){}),define("StorageManager",[],function(){function e(e,t,n){var i=new Blob([new Uint8Array(e)]);n(new File([i],t))}function t(e){var n=typeof e;if("object"==n){for(var i in e)if(e.hasOwnProperty(i)){var r=e[i],a=typeof r;if("function"==a)delete e[i];else if("array"==a)for(var o=0;o<r.length;o++)t(r[o]);else"object"==a&&t(r)}}else if("array"==n)for(var o=0;o<e.length;o++)t(e[o]);return e}var n,i=indexedDB,r=(IDBTransaction,IDBKeyRange,function(t,i,r,a){var o=n.transaction(["books"],"readonly").objectStore("books").get(t);o.onerror=function(e){null!=r&&r()},o.onsuccess=function(t){if(null!=i&&t.target.result){var n=t.target.result.content,r=t.target.result.id.split("/").pop();a&&n instanceof ArrayBuffer?e(n,r,function(e){i(e)}):i(t.target.result.content)}else i()}}),a=function(e,t){var n,i=new FileReader;i.onload=function(e){n=e.target.result,t(n)},i.readAsArrayBuffer(e)},o=function(e,t,i){var r=n.transaction(["books"],"readwrite").objectStore("books").delete(e);r.onerror=function(e){null!=i&&i()},r.onsuccess=function(e){null!=t&&t()}},s=function(e,i,r,a){var o={id:e,content:i},s=n.transaction(["books"],"readwrite").objectStore("books").put(t(o));s.onerror=function(e){null!=a&&a(e)},s.onsuccess=function(e){null!=r&&r(e.target.result)}},l=function(e){window.tempBookshelf&&window.tempBookshelf.push(e)},c=function(e,i,r,a){var o={id:e,content:i},s=n.transaction(["books"],"readwrite").objectStore("books").put(t(o));s.onerror=function(e){null!=a&&a(e)},s.onsuccess=function(e){null!=r&&r(e.target.result)}},f=function(){var e=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"];if(navigator.platform)for(;e.length;)if(navigator.platform===e.pop())return!0;return!1}();return{saveFile:function(e,t,n,i){f?a(t,function(t){c(e,t,n,i)}):c(e,t,n,i)},saveBookshelf:function(e,t,n,i){s(e,t,n,i)},saveTemporaryBookshelf:function(e){l(e)},getFile:function(e,t,n){r(e,t,n,f)},deleteFile:function(e,t,n){o(e,t,n)},getPathUrl:function(e){return"db://"+e},initStorage:function(e,t){var r=i.open("bookshelf",2);r.onupgradeneeded=function(e){n=e.target.result;for(var t=n.objectStoreNames,i=0;i<t.length;i++)n.deleteObjectStore(t[i]);n.createObjectStore("books",{keyPath:"id"})},r.onsuccess=function(t){n=t.target.result,e()},r.onerror=function(e){}}}}),function(e){"use strict";function t(){this.crc=-1}function n(){}function i(e,t,n){if(t<0||n<0||t+n>e.size)throw new RangeError("offset:"+t+", length:"+n+", size:"+e.size);return e.slice?e.slice(t,t+n):e.webkitSlice?e.webkitSlice(t,t+n):e.mozSlice?e.mozSlice(t,t+n):e.msSlice?e.msSlice(t,t+n):void 0}function r(e,t){var n,i;return n=new ArrayBuffer(e),i=new Uint8Array(n),t&&i.set(t,0),{buffer:n,array:i,view:new DataView(n)}}function a(){}function o(e){function t(t,n){var a=new Blob([e],{type:W});i=new l(a),i.init(function(){r.size=i.size,t()},n)}function n(e,t,n,r){i.readUint8Array(e,t,n,r)}var i,r=this;r.size=0,r.init=t,r.readUint8Array=n}function s(t){function n(e){for(var n=t.length;"="==t.charAt(n-1);)n--;a=t.indexOf(",")+1,o.size=Math.floor(.75*(n-a)),e()}function i(n,i,o){var s,l=r(i),c=4*Math.floor(n/3),f=4*Math.ceil((n+i)/3),u=e.atob(t.substring(c+a,f+a)),d=n-3*Math.floor(c/4);for(s=d;s<d+i;s++)l.array[s-d]=u.charCodeAt(s);o(l.array)}var a,o=this;o.size=0,o.init=n,o.readUint8Array=i}function l(e){function t(t){r.size=e.size,t()}function n(t,n,r,a){var o=new FileReader;o.onload=function(e){r(new Uint8Array(e.target.result))},o.onerror=a;try{o.readAsArrayBuffer(i(e,t,n))}catch(e){a(e)}}var r=this;r.size=0,r.init=t,r.readUint8Array=n}function c(){}function f(e){function t(e){r=new Blob([],{type:W}),e()}function n(e,t){r=new Blob([r,P?e:e.buffer],{type:W}),t()}function i(t,n){var i=new FileReader;i.onload=function(e){t(e.target.result)},i.onerror=n,i.readAsText(r,e)}var r,a=this;a.init=t,a.writeUint8Array=n,a.getData=i}function u(t){function n(e){o+="data:"+(t||"")+";base64,",e()}function i(t,n){var i,r=s.length,a=s;for(s="",i=0;i<3*Math.floor((r+t.length)/3)-r;i++)a+=String.fromCharCode(t[i]);for(;i<t.length;i++)s+=String.fromCharCode(t[i]);a.length>2?o+=e.btoa(a):s=a,n()}function r(t){t(o+e.btoa(s))}var a=this,o="",s="";a.init=n,a.writeUint8Array=i,a.getData=r}function d(e){function t(e){e()}function n(e,t){r.push(P?e:e.buffer),t()}function i(t){t(new Blob(r,{type:e}))}var r=[],a=this;a.init=t,a.writeUint8Array=n,a.getData=i}function _(e,t,n,i,r,a,o,s,l,c){function f(){e.removeEventListener("message",u,!1),s(h,p)}function u(t){var n=t.data,r=n.data,s=n.error;if(s)return s.toString=function(){return"Error: "+this.message},void l(s);if(n.sn===v)switch("number"==typeof n.codecTime&&(e.codecTime+=n.codecTime),"number"==typeof n.crcTime&&(e.crcTime+=n.crcTime),n.type){case"append":r?(h+=r.length,i.writeUint8Array(r,function(){d()},c)):d();break;case"flush":p=n.crc,r?(h+=r.length,i.writeUint8Array(r,function(){f()},c)):f();break;case"progress":o&&o(_+n.loaded,a);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",n)}}function d(){_=b*j,_<=a?n.readUint8Array(r+_,Math.min(j,a-_),function(n){o&&o(_,a);var i=0===_?t:{sn:v};i.type="append",i.data=n;try{e.postMessage(i,[n.buffer])}catch(t){e.postMessage(i)}b++},l):e.postMessage({sn:v,type:"flush"})}var _,h,p,b=0,v=t.sn;h=0,e.addEventListener("message",u,!1),d()}function h(e,n,i,r,a,o,s,l,c,f){function u(){var t;if((d=_*j)<a)n.readUint8Array(r+d,Math.min(j,a-d),function(t){var n;try{n=e.append(t,function(e){s&&s(d+e,a)})}catch(e){return void c(e)}n?(h+=n.length,i.writeUint8Array(n,function(){_++,setTimeout(u,1)},f),b&&v.append(n)):(_++,setTimeout(u,1)),p&&v.append(t),s&&s(d,a)},c);else{try{t=e.flush()}catch(e){return void c(e)}t?(b&&v.append(t),h+=t.length,i.writeUint8Array(t,function(){l(h,v.get())},f)):l(h,v.get())}}var d,_=0,h=0,p="input"===o,b="output"===o,v=new t;u()}function p(t,n,i,r,a,o,s,l,c,f,u){var d=s?"output":"none";if(e.zip.useWebWorkers){_(t,{sn:n,codecClass:"Inflater",crcType:d},i,r,a,o,c,l,f,u)}else h(new e.zip.Inflater,i,r,a,o,d,c,l,f,u)}function b(t,n,i,r,a,o,s,l,c){if(e.zip.useWebWorkers){_(t,{sn:n,options:{level:a},codecClass:"Deflater",crcType:"input"},i,r,0,i.size,s,o,l,c)}else h(new e.zip.Deflater,i,r,0,i.size,"input",s,o,l,c)}function v(t,i,r,a,o,s,l,c,f,u,d){if(e.zip.useWebWorkers&&l){_(t,{sn:i,codecClass:"NOOP",crcType:"input"},r,a,o,s,f,c,u,d)}else h(new n,r,a,o,s,"input",f,c,u,d)}function w(e){var t,n,i="",r=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(t=0;t<e.length;t++)n=255&e.charCodeAt(t),i+=n>127?r[n-128]:String.fromCharCode(n);return i}function g(e){return decodeURIComponent(escape(e))}function y(e){var t,n="";for(t=0;t<e.length;t++)n+=String.fromCharCode(e[t]);return n}function m(e){var t=(4294901760&e)>>16,n=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&n)>>11,(2016&n)>>5,2*(31&n),0)}catch(e){}}function x(e,t,n,i,r){return e.version=t.view.getUint16(n,!0),e.bitFlag=t.view.getUint16(n+2,!0),e.compressionMethod=t.view.getUint16(n+4,!0),e.lastModDateRaw=t.view.getUint32(n+6,!0),e.lastModDate=m(e.lastModDateRaw),1==(1&e.bitFlag)?void r(z):((i||8!=(8&e.bitFlag))&&(e.crc32=t.view.getUint32(n+10,!0),e.compressedSize=t.view.getUint32(n+14,!0),e.uncompressedSize=t.view.getUint32(n+18,!0)),4294967295===e.compressedSize||4294967295===e.uncompressedSize?void r(O):(e.filenameLength=t.view.getUint16(n+22,!0),void(e.extraFieldLength=t.view.getUint16(n+24,!0))))}function k(t,n,i){function a(){}function o(e){function n(n,a){t.readUint8Array(t.size-n,n,function(t){for(var n=t.length-r;n>=0;n--)if(80===t[n]&&75===t[n+1]&&5===t[n+2]&&6===t[n+3])return void e(new DataView(t.buffer,n,r));a()},function(){i(F)})}var r=22;if(t.size<r)return void i(D);var a=r+65536;n(r,function(){n(Math.min(a,t.size),function(){i(D)})})}var s=0;a.prototype.getData=function(e,n,a,o){function l(e){var t=r(4);return t.view.setUint32(0,e),d.crc32==t.view.getUint32(0)}function c(t,r){o&&!l(r)?i(T):e.getData(function(e){n(e)})}function f(e){i(e||L)}function u(e){i(e||C)}var d=this;t.readUint8Array(d.offset,30,function(n){var l,_=r(n.length,n);if(1347093252!=_.view.getUint32(0))return void i(D);x(d,_,4,!1,i),l=d.offset+30+d.filenameLength+d.extraFieldLength,e.init(function(){0===d.compressionMethod?v(d._worker,s++,t,e,l,d.compressedSize,o,c,a,f,u):p(d._worker,s++,t,e,l,d.compressedSize,o,c,a,f,u)},u)},f)};var l={getEntries:function(e){var n=this._worker;o(function(o){var s,l;if(s=o.getUint32(16,!0),l=o.getUint16(8,!0),s<0||s>=t.size)return void i(D);t.readUint8Array(s,t.size-s,function(t){var o,s,c,f,u=0,d=[],_=r(t.length,t);for(o=0;o<l;o++){if(s=new a,s._worker=n,1347092738!=_.view.getUint32(u))return void i(D);x(s,_,u+6,!0,i),s.commentLength=_.view.getUint16(u+32,!0),s.directory=16==(16&_.view.getUint8(u+38)),s.offset=_.view.getUint32(u+42,!0),c=y(_.array.subarray(u+46,u+46+s.filenameLength)),s.filename=2048==(2048&s.bitFlag)?g(c):w(c),s.directory||"/"!=s.filename.charAt(s.filename.length-1)||(s.directory=!0),f=y(_.array.subarray(u+46+s.filenameLength+s.extraFieldLength,u+46+s.filenameLength+s.extraFieldLength+s.commentLength)),s.comment=2048==(2048&s.bitFlag)?g(f):w(f),d.push(s),u+=46+s.filenameLength+s.extraFieldLength+s.commentLength}e(d)},function(){i(F)})})},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null),e&&e()},_worker:null};e.zip.useWebWorkers?A("inflater",function(e){l._worker=e,n(l)},function(e){i(e)}):n(l)}function E(e){return unescape(encodeURIComponent(e))}function S(e){var t,n=[];for(t=0;t<e.length;t++)n.push(e.charCodeAt(t));return n}function R(t,n,i,a){function o(e){i(e||B)}function s(e){i(e||L)}var l={},c=[],f=0,u=0,d={add:function(e,n,d,_,h){function p(n){var i;x=h.lastModDate||new Date,y=r(26),l[e]={headerArray:y.array,directory:h.directory,filename:m,offset:f,comment:S(E(h.comment||""))},y.view.setUint32(0,335546376),h.version&&y.view.setUint8(0,h.version),a||0===h.level||h.directory||y.view.setUint16(4,2048),y.view.setUint16(6,(x.getHours()<<6|x.getMinutes())<<5|x.getSeconds()/2,!0),y.view.setUint16(8,(x.getFullYear()-1980<<4|x.getMonth()+1)<<5|x.getDate(),!0),y.view.setUint16(22,m.length,!0),i=r(30+m.length),i.view.setUint32(0,1347093252),i.array.set(y.array,4),i.array.set(m,30),f+=i.array.length,t.writeUint8Array(i.array,n,o)}function w(e,i){var a=r(16);f+=e||0,a.view.setUint32(0,1347094280),void 0!==i&&(y.view.setUint32(10,i,!0),a.view.setUint32(4,i,!0)),n&&(a.view.setUint32(8,e,!0),y.view.setUint32(14,e,!0),a.view.setUint32(12,n.size,!0),y.view.setUint32(18,n.size,!0)),t.writeUint8Array(a.array,function(){f+=16,d()},o)}function g(){if(h=h||{},e=e.trim(),h.directory&&"/"!=e.charAt(e.length-1)&&(e+="/"),l.hasOwnProperty(e))return void i(M);m=S(E(e)),c.push(e),p(function(){n?a||0===h.level?v(k,u++,n,t,0,n.size,!0,w,_,s,o):b(k,u++,n,t,h.level,w,_,s,o):w()},o)}var y,m,x,k=this._worker;n?n.init(g,s):g()},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null);var n,i,a,s=0,u=0;for(i=0;i<c.length;i++)a=l[c[i]],s+=46+a.filename.length+a.comment.length;for(n=r(s+22),i=0;i<c.length;i++)a=l[c[i]],n.view.setUint32(u,1347092738),n.view.setUint16(u+4,5120),n.array.set(a.headerArray,u+6),n.view.setUint16(u+32,a.comment.length,!0),a.directory&&n.view.setUint8(u+38,16),n.view.setUint32(u+42,a.offset,!0),n.array.set(a.filename,u+46),n.array.set(a.comment,u+46+a.filename.length),u+=46+a.filename.length+a.comment.length;n.view.setUint32(u,1347093766),n.view.setUint16(u+8,c.length,!0),n.view.setUint16(u+10,c.length,!0),n.view.setUint32(u+12,s,!0),n.view.setUint32(u+16,f,!0),t.writeUint8Array(n.array,function(){t.getData(e)},o)},_worker:null};e.zip.useWebWorkers?A("deflater",function(e){d._worker=e,n(d)},function(e){i(e)}):n(d)}function U(e){var t=document.createElement("a");return e.map(function(e){return t.href=e,t.href})}function A(t,n,i){function r(e){var t=e.data;if(t.error)return s.terminate(),void i(t.error);"importScripts"===t.type&&(s.removeEventListener("message",r),s.removeEventListener("error",a),n(s))}function a(e){s.terminate(),i(e)}if(null!==e.zip.workerScripts&&null!==e.zip.workerScriptsPath)return void i(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));var o;if(e.zip.workerScripts){if(o=e.zip.workerScripts[t],!Array.isArray(o))return void i(new Error("zip.workerScripts."+t+" is not an array!"));o=U(o)}else o=H[t].slice(0),o[0]=(e.zip.workerScriptsPath||"")+o[0];var s=new Worker(o[0]);s.codecTime=s.crcTime=0,s.postMessage({type:"importScripts",scripts:o.slice(1)}),s.addEventListener("message",r),s.addEventListener("error",a)}function I(e){console.error(e)}var P,D="File format is not recognized.",T="CRC failed.",z="File contains encrypted entry.",O="File is using Zip64 (4gb+ file size).",F="Error while reading zip file.",B="Error while writing zip file.",C="Error while writing file data.",L="Error while reading file data.",M="File already exists.",j=524288,W="text/plain";try{P=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}t.prototype.append=function(e){for(var t=0|this.crc,n=this.table,i=0,r=0|e.length;i<r;i++)t=t>>>8^n[255&(t^e[i])];this.crc=t},t.prototype.get=function(){return~this.crc},t.prototype.table=function(){var e,t,n,i=[];for(e=0;e<256;e++){for(n=e,t=0;t<8;t++)1&n?n=n>>>1^3988292384:n>>>=1;i[e]=n}return i}(),n.prototype.append=function(e,t){return e},n.prototype.flush=function(){},o.prototype=new a,o.prototype.constructor=o,s.prototype=new a,s.prototype.constructor=s,l.prototype=new a,l.prototype.constructor=l,c.prototype.getData=function(e){e(this.data)},f.prototype=new c,f.prototype.constructor=f,u.prototype=new c,u.prototype.constructor=u,d.prototype=new c,d.prototype.constructor=d;var H={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};e.zip={Reader:a,Writer:c,BlobReader:l,Data64URIReader:s,TextReader:o,BlobWriter:d,Data64URIWriter:u,TextWriter:f,createReader:function(e,t,n){n=n||I,e.init(function(){k(e,t,n)},n)},createWriter:function(e,t,n,i){n=n||I,i=!!i,e.init(function(){R(e,t,n,i)},n)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(this),define("zip",function(e){return function(){return e.zip}}(this)),define("readium_js_viewer/workers/Messages",[],function(){return{IMPORT_ZIP:0,OVERWRITE_CONTINUE:1,FIND_PACKAGE_RESPONSE:2,PARSE_PACKAGE_RESPONSE:3,DELETE_EPUB:4,IMPORT_DIR:5,IMPORT_URL:6,MIGRATE:7,OVERWRITE_SIDE_BY_SIDE:8,CONTINUE_IMPORT_ZIP:9,SUCCESS:100,PROGRESS:101,ERROR:102,OVERWRITE:103,FIND_PACKAGE:104,PARSE_PACKAGE:105,PROGRESS_EXTRACTING:200,PROGRESS_WRITING:201,PROGRESS_DELETING:202,PROGRESS_MIGRATING:203,ERROR_STORAGE:300,ERROR_EPUB:301,ERROR_AJAX:302,ERROR_PACKAGE_PARSE:303,READY:400,STORE_TEMP_BOOKSHELF:500}}),function(e){"use strict";function t(){function e(e,t,n,i,c,f,d,h,b,v,w){var g,y,m,x,k,S,R,U,A,I,P,D,T,z,O;I=0,k=n;do{r[e[t+I]]++,I++,k--}while(0!==k);if(r[0]==n)return d[0]=-1,h[0]=0,s;for(U=h[0],S=1;S<=E&&0===r[S];S++);for(R=S,U<S&&(U=S),k=E;0!==k&&0===r[k];k--);for(m=k,U>k&&(U=k),h[0]=U,z=1<<S;S<k;S++,z<<=1)if((z-=r[S])<0)return u;if((z-=r[k])<0)return u;for(r[k]+=z,l[1]=S=0,I=1,T=2;0!=--k;)l[T]=S+=r[I],T++,I++;k=0,I=0;do{0!==(S=e[t+I])&&(w[l[S]++]=k),I++}while(++k<n);for(n=l[m],l[0]=k=0,I=0,x=-1,D=-U,o[0]=0,P=0,O=0;R<=m;R++)for(g=r[R];0!=g--;){for(;R>D+U;){if(x++,D+=U,O=m-D,O=O>U?U:O,(y=1<<(S=R-D))>g+1&&(y-=g+1,T=R,S<O))for(;++S<O&&!((y<<=1)<=r[++T]);)y-=r[T];if(O=1<<S,v[0]+O>p)return u;o[x]=P=v[0],v[0]+=O,0!==x?(l[x]=k,a[0]=S,a[1]=U,S=k>>>D-U,a[2]=P-o[x-1]-S,b.set(a,3*(o[x-1]+S))):d[0]=P}for(a[1]=R-D,I>=n?a[0]=192:w[I]<i?(a[0]=w[I]<256?0:96,a[2]=w[I++]):(a[0]=f[w[I]-i]+16+64,a[2]=c[w[I++]-i]),y=1<<R-D,S=k>>>D;S<O;S+=y)b.set(a,3*(P+S));for(S=1<<R-1;0!=(k&S);S>>>=1)k^=S;for(k^=S,A=(1<<D)-1;(k&A)!=l[x];)x--,D-=U,A=(1<<D)-1}return 0!==z&&1!=m?_:s}function t(e){var t;for(n||(n=[],i=[],r=new Int32Array(E+1),a=[],o=new Int32Array(E),l=new Int32Array(E+1)),i.length<e&&(i=[]),t=0;t<e;t++)i[t]=0;for(t=0;t<E+1;t++)r[t]=0;for(t=0;t<3;t++)a[t]=0;o.set(r.subarray(0,E),0),l.set(r.subarray(0,E+1),0)}var n,i,r,a,o,l,c=this;c.inflate_trees_bits=function(r,a,o,s,l){var c;return t(19),n[0]=0,c=e(r,0,19,19,null,null,o,a,s,n,i),c==u?l.msg="oversubscribed dynamic bit lengths tree":c!=_&&0!==a[0]||(l.msg="incomplete dynamic bit lengths tree",c=u),c},c.inflate_trees_dynamic=function(r,a,o,l,c,f,h,p,b){var v;return t(288),n[0]=0,(v=e(o,0,r,257,y,m,f,l,p,n,i))!=s||0===l[0]?(v==u?b.msg="oversubscribed literal/length tree":v!=d&&(b.msg="incomplete literal/length tree",v=u),v):(t(288),v=e(o,r,a,0,x,k,h,c,p,n,i),v!=s||0===c[0]&&r>257?(v==u?b.msg="oversubscribed distance tree":v==_?(b.msg="incomplete distance tree",v=u):v!=d&&(b.msg="empty distance tree with lengths",v=u),v):s)}}function n(){function e(e,t,n,i,r,a,o,c){var f,d,_,p,b,v,w,g,y,m,x,k,E,S,R,U;w=c.next_in_index,g=c.avail_in,b=o.bitb,v=o.bitk,y=o.write,m=y<o.read?o.read-y-1:o.end-y,x=h[e],k=h[t];do{for(;v<20;)g--,b|=(255&c.read_byte(w++))<<v,v+=8;if(f=b&x,d=n,_=i,U=3*(_+f),0!==(p=d[U]))for(;;){if(b>>=d[U+1],v-=d[U+1],0!=(16&p)){for(p&=15,E=d[U+2]+(b&h[p]),b>>=p,v-=p;v<15;)g--,b|=(255&c.read_byte(w++))<<v,v+=8;for(f=b&k,d=r,_=a,U=3*(_+f),p=d[U];;){if(b>>=d[U+1],v-=d[U+1],0!=(16&p)){for(p&=15;v<p;)g--,b|=(255&c.read_byte(w++))<<v,v+=8;if(S=d[U+2]+(b&h[p]),b>>=p,v-=p,m-=E,y>=S)R=y-S,y-R>0&&2>y-R?(o.window[y++]=o.window[R++],o.window[y++]=o.window[R++],E-=2):(o.window.set(o.window.subarray(R,R+2),y),y+=2,R+=2,E-=2);else{R=y-S;do{R+=o.end}while(R<0);if(p=o.end-R,E>p){if(E-=p,y-R>0&&p>y-R)do{o.window[y++]=o.window[R++]}while(0!=--p);else o.window.set(o.window.subarray(R,R+p),y),y+=p,R+=p,p=0;R=0}}if(y-R>0&&E>y-R)do{o.window[y++]=o.window[R++]}while(0!=--E);else o.window.set(o.window.subarray(R,R+E),y),y+=E,R+=E,E=0;break}if(0!=(64&p))return c.msg="invalid distance code",E=c.avail_in-g,E=v>>3<E?v>>3:E,g+=E,w-=E,v-=E<<3,o.bitb=b,o.bitk=v,c.avail_in=g,c.total_in+=w-c.next_in_index,c.next_in_index=w,o.write=y,u;f+=d[U+2],f+=b&h[p],U=3*(_+f),p=d[U]}break}if(0!=(64&p))return 0!=(32&p)?(E=c.avail_in-g,E=v>>3<E?v>>3:E,g+=E,w-=E,v-=E<<3,o.bitb=b,o.bitk=v,c.avail_in=g,c.total_in+=w-c.next_in_index,c.next_in_index=w,o.write=y,l):(c.msg="invalid literal/length code",E=c.avail_in-g,E=v>>3<E?v>>3:E,g+=E,w-=E,v-=E<<3,o.bitb=b,o.bitk=v,c.avail_in=g,c.total_in+=w-c.next_in_index,c.next_in_index=w,o.write=y,u);if(f+=d[U+2],f+=b&h[p],U=3*(_+f),0===(p=d[U])){b>>=d[U+1],v-=d[U+1],o.window[y++]=d[U+2],m--;break}}else b>>=d[U+1],v-=d[U+1],o.window[y++]=d[U+2],m--}while(m>=258&&g>=10);return E=c.avail_in-g,E=v>>3<E?v>>3:E,g+=E,w-=E,v-=E<<3,o.bitb=b,o.bitk=v,c.avail_in=g,c.total_in+=w-c.next_in_index,c.next_in_index=w,o.write=y,s}var t,n,i,r,a=this,o=0,c=0,d=0,_=0,p=0,b=0,v=0,w=0,g=0,y=0;a.init=function(e,a,o,s,l,c){t=S,v=e,w=a,i=o,g=s,r=l,y=c,n=null},a.proc=function(a,m,x){var k,E,F,B,C,L,M,j=0,W=0,H=0;for(H=m.next_in_index,B=m.avail_in,j=a.bitb,W=a.bitk,C=a.write,L=C<a.read?a.read-C-1:a.end-C;;)switch(t){case S:if(L>=258&&B>=10&&(a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,x=e(v,w,i,g,r,y,a,m),H=m.next_in_index,B=m.avail_in,j=a.bitb,W=a.bitk,C=a.write,L=C<a.read?a.read-C-1:a.end-C,x!=s)){t=x==l?T:O;break}d=v,n=i,c=g,t=R;case R:for(k=d;W<k;){if(0===B)return a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);x=s,B--,j|=(255&m.read_byte(H++))<<W,W+=8}if(E=3*(c+(j&h[k])),j>>>=n[E+1],W-=n[E+1],0===(F=n[E])){_=n[E+2],t=D;break}if(0!=(16&F)){p=15&F,o=n[E+2],t=U;break}if(0==(64&F)){d=F,c=E/3+n[E+2];break}if(0!=(32&F)){t=T;break}return t=O,m.msg="invalid literal/length code",x=u,a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);case U:for(k=p;W<k;){if(0===B)return a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);x=s,B--,j|=(255&m.read_byte(H++))<<W,W+=8}o+=j&h[k],j>>=k,W-=k,d=w,n=r,c=y,t=A;case A:for(k=d;W<k;){if(0===B)return a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);x=s,B--,j|=(255&m.read_byte(H++))<<W,W+=8}if(E=3*(c+(j&h[k])),j>>=n[E+1],W-=n[E+1],0!=(16&(F=n[E]))){p=15&F,b=n[E+2],t=I;break}if(0==(64&F)){d=F,c=E/3+n[E+2];break}return t=O,m.msg="invalid distance code",x=u,a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);case I:for(k=p;W<k;){if(0===B)return a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);x=s,B--,j|=(255&m.read_byte(H++))<<W,W+=8}b+=j&h[k],j>>=k,W-=k,t=P;case P:for(M=C-b;M<0;)M+=a.end;for(;0!==o;){if(0===L&&(C==a.end&&0!==a.read&&(C=0,L=C<a.read?a.read-C-1:a.end-C),0===L&&(a.write=C,x=a.inflate_flush(m,x),C=a.write,L=C<a.read?a.read-C-1:a.end-C,C==a.end&&0!==a.read&&(C=0,L=C<a.read?a.read-C-1:a.end-C),0===L)))return a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);a.window[C++]=a.window[M++],L--,M==a.end&&(M=0),o--}t=S;break;case D:if(0===L&&(C==a.end&&0!==a.read&&(C=0,L=C<a.read?a.read-C-1:a.end-C),0===L&&(a.write=C,x=a.inflate_flush(m,x),C=a.write,L=C<a.read?a.read-C-1:a.end-C,C==a.end&&0!==a.read&&(C=0,L=C<a.read?a.read-C-1:a.end-C),0===L)))return a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);x=s,a.window[C++]=_,L--,t=S;break;case T:if(W>7&&(W-=8,B++,H--),a.write=C,x=a.inflate_flush(m,x),C=a.write,L=C<a.read?a.read-C-1:a.end-C,a.read!=a.write)return a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);t=z;case z:return x=l,a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);case O:return x=u,a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x);default:return x=f,a.bitb=j,a.bitk=W,m.avail_in=B,m.total_in+=H-m.next_in_index,m.next_in_index=H,a.write=C,a.inflate_flush(m,x)}},a.free=function(){}}function i(e,i){var r,a=this,o=B,c=0,d=0,b=0,v=[0],w=[0],g=new n,y=0,m=new Int32Array(3*p),x=new t;a.bitk=0,a.bitb=0,a.window=new Uint8Array(i),a.end=i,a.read=0,a.write=0,a.reset=function(e,t){t&&(t[0]=0),o==H&&g.free(e),o=B,a.bitk=0,a.bitb=0,a.read=a.write=0},a.reset(e,null),a.inflate_flush=function(e,t){var n,i,r;return i=e.next_out_index,r=a.read,n=(r<=a.write?a.write:a.end)-r,n>e.avail_out&&(n=e.avail_out),0!==n&&t==_&&(t=s),e.avail_out-=n,e.total_out+=n,e.next_out.set(a.window.subarray(r,r+n),i),i+=n,r+=n,r==a.end&&(r=0,a.write==a.end&&(a.write=0),n=a.write-r,n>e.avail_out&&(n=e.avail_out),0!==n&&t==_&&(t=s),e.avail_out-=n,e.total_out+=n,e.next_out.set(a.window.subarray(r,r+n),i),i+=n,r+=n),e.next_out_index=i,a.read=r,t},a.proc=function(e,n){var i,_,p,k,E,S,R,U;for(k=e.next_in_index,E=e.avail_in,_=a.bitb,p=a.bitk,S=a.write,R=S<a.read?a.read-S-1:a.end-S;;)switch(o){case B:for(;p<3;){if(0===E)return a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);n=s,E--,_|=(255&e.read_byte(k++))<<p,p+=8}switch(i=7&_,y=1&i,i>>>1){case 0:_>>>=3,p-=3,i=7&p,_>>>=i,p-=i,o=C;break;case 1:var A=[],I=[],P=[[]],D=[[]];t.inflate_trees_fixed(A,I,P,D),g.init(A[0],I[0],P[0],0,D[0],0),_>>>=3,p-=3,o=H;break;case 2:_>>>=3,p-=3,o=M;break;case 3:return _>>>=3,p-=3,o=Z,e.msg="invalid block type",n=u,a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n)}break;case C:for(;p<32;){if(0===E)return a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);n=s,E--,_|=(255&e.read_byte(k++))<<p,p+=8}if((~_>>>16&65535)!=(65535&_))return o=Z,e.msg="invalid stored block lengths",n=u,a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);c=65535&_,_=p=0,o=0!==c?L:0!==y?N:B;break;case L:if(0===E)return a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);if(0===R&&(S==a.end&&0!==a.read&&(S=0,R=S<a.read?a.read-S-1:a.end-S),0===R&&(a.write=S,n=a.inflate_flush(e,n),S=a.write,R=S<a.read?a.read-S-1:a.end-S,S==a.end&&0!==a.read&&(S=0,R=S<a.read?a.read-S-1:a.end-S),0===R)))return a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);if(n=s,i=c,i>E&&(i=E),i>R&&(i=R),a.window.set(e.read_buf(k,i),S),k+=i,E-=i,S+=i,R-=i,0!=(c-=i))break;o=0!==y?N:B;break;case M:for(;p<14;){if(0===E)return a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);n=s,E--,_|=(255&e.read_byte(k++))<<p,p+=8}if(d=i=16383&_,(31&i)>29||(i>>5&31)>29)return o=Z,e.msg="too many length or distance symbols",n=u,a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);if(i=258+(31&i)+(i>>5&31),!r||r.length<i)r=[];else for(U=0;U<i;U++)r[U]=0;_>>>=14,p-=14,b=0,o=j;case j:for(;b<4+(d>>>10);){for(;p<3;){if(0===E)return a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);n=s,E--,_|=(255&e.read_byte(k++))<<p,p+=8}r[F[b++]]=7&_,_>>>=3,p-=3}for(;b<19;)r[F[b++]]=0;if(v[0]=7,(i=x.inflate_trees_bits(r,v,w,m,e))!=s)return n=i,n==u&&(r=null,o=Z),a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);b=0,o=W;case W:for(;;){if(i=d,b>=258+(31&i)+(i>>5&31))break;var T,z;for(i=v[0];p<i;){if(0===E)return a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);n=s,E--,_|=(255&e.read_byte(k++))<<p,p+=8}if(i=m[3*(w[0]+(_&h[i]))+1],(z=m[3*(w[0]+(_&h[i]))+2])<16)_>>>=i,p-=i,r[b++]=z;else{for(U=18==z?7:z-14,T=18==z?11:3;p<i+U;){if(0===E)return a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);n=s,E--,_|=(255&e.read_byte(k++))<<p,p+=8}if(_>>>=i,p-=i,T+=_&h[U],_>>>=U,p-=U,U=b,i=d,U+T>258+(31&i)+(i>>5&31)||16==z&&U<1)return r=null,o=Z,e.msg="invalid bit length repeat",n=u,a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);z=16==z?r[U-1]:0;do{r[U++]=z}while(0!=--T);b=U}}w[0]=-1;var O=[],J=[],K=[],q=[];if(O[0]=9,J[0]=6,i=d,(i=x.inflate_trees_dynamic(257+(31&i),1+(i>>5&31),r,O,J,K,q,m,e))!=s)return i==u&&(r=null,o=Z),n=i,a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);g.init(O[0],J[0],m,K[0],m,q[0]),o=H;case H:if(a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,(n=g.proc(a,e,n))!=l)return a.inflate_flush(e,n);if(n=s,g.free(e),k=e.next_in_index,E=e.avail_in,_=a.bitb,p=a.bitk,S=a.write,R=S<a.read?a.read-S-1:a.end-S,0===y){o=B;break}o=N;case N:if(a.write=S,n=a.inflate_flush(e,n),S=a.write,R=S<a.read?a.read-S-1:a.end-S,a.read!=a.write)return a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);o=G;case G:return n=l,a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);case Z:return n=u,a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n);default:return n=f,a.bitb=_,a.bitk=p,e.avail_in=E,e.total_in+=k-e.next_in_index,e.next_in_index=k,a.write=S,a.inflate_flush(e,n)}},a.free=function(e){a.reset(e,null),a.window=null,m=null},a.set_dictionary=function(e,t,n){a.window.set(e.subarray(t,t+n),0),a.read=a.write=n},a.sync_point=function(){return o==C?1:0}}function r(){function e(e){return e&&e.istate?(e.total_in=e.total_out=0,e.msg=null,e.istate.mode=te,e.istate.blocks.reset(e,null),s):f}var t=this;t.mode=0,t.method=0,t.was=[0],t.need=0,t.marker=0,t.wbits=0,
t.inflateEnd=function(e){return t.blocks&&t.blocks.free(e),t.blocks=null,s},t.inflateInit=function(n,r){return n.msg=null,t.blocks=null,r<8||r>15?(t.inflateEnd(n),f):(t.wbits=r,n.istate.blocks=new i(n,1<<r),e(n),s)},t.inflate=function(e,t){var n,i;if(!e||!e.istate||!e.next_in)return f;for(t=t==v?_:s,n=_;;)switch(e.istate.mode){case q:if(0===e.avail_in)return n;if(n=t,e.avail_in--,e.total_in++,(15&(e.istate.method=e.read_byte(e.next_in_index++)))!=K){e.istate.mode=ie,e.msg="unknown compression method",e.istate.marker=5;break}if(8+(e.istate.method>>4)>e.istate.wbits){e.istate.mode=ie,e.msg="invalid window size",e.istate.marker=5;break}e.istate.mode=$;case $:if(0===e.avail_in)return n;if(n=t,e.avail_in--,e.total_in++,i=255&e.read_byte(e.next_in_index++),((e.istate.method<<8)+i)%31!=0){e.istate.mode=ie,e.msg="incorrect header check",e.istate.marker=5;break}if(0==(i&J)){e.istate.mode=te;break}e.istate.mode=V;case V:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need=(255&e.read_byte(e.next_in_index++))<<24&4278190080,e.istate.mode=X;case X:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need+=(255&e.read_byte(e.next_in_index++))<<16&16711680,e.istate.mode=Y;case Y:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need+=(255&e.read_byte(e.next_in_index++))<<8&65280,e.istate.mode=Q;case Q:return 0===e.avail_in?n:(n=t,e.avail_in--,e.total_in++,e.istate.need+=255&e.read_byte(e.next_in_index++),e.istate.mode=ee,c);case ee:return e.istate.mode=ie,e.msg="need dictionary",e.istate.marker=0,f;case te:if((n=e.istate.blocks.proc(e,n))==u){e.istate.mode=ie,e.istate.marker=0;break}if(n==s&&(n=t),n!=l)return n;n=t,e.istate.blocks.reset(e,e.istate.was),e.istate.mode=ne;case ne:return l;case ie:return u;default:return f}},t.inflateSetDictionary=function(e,t,n){var i=0,r=n;return e&&e.istate&&e.istate.mode==ee?(r>=1<<e.istate.wbits&&(r=(1<<e.istate.wbits)-1,i=n-r),e.istate.blocks.set_dictionary(t,i,r),e.istate.mode=te,s):f},t.inflateSync=function(t){var n,i,r,a,o;if(!t||!t.istate)return f;if(t.istate.mode!=ie&&(t.istate.mode=ie,t.istate.marker=0),0===(n=t.avail_in))return _;for(i=t.next_in_index,r=t.istate.marker;0!==n&&r<4;)t.read_byte(i)==re[r]?r++:r=0!==t.read_byte(i)?0:4-r,i++,n--;return t.total_in+=i-t.next_in_index,t.next_in_index=i,t.avail_in=n,t.istate.marker=r,4!=r?u:(a=t.total_in,o=t.total_out,e(t),t.total_in=a,t.total_out=o,t.istate.mode=te,s)},t.inflateSyncPoint=function(e){return e&&e.istate&&e.istate.blocks?e.istate.blocks.sync_point():f}}function a(){}function o(){var e=this,t=new a,n=b,i=new Uint8Array(512),r=!1;t.inflateInit(),t.next_out=i,e.append=function(e,a){var o,c,f=[],u=0,d=0,h=0;if(0!==e.length){t.next_in_index=0,t.next_in=e,t.avail_in=e.length;do{if(t.next_out_index=0,t.avail_out=512,0!==t.avail_in||r||(t.next_in_index=0,r=!0),o=t.inflate(n),r&&o===_){if(0!==t.avail_in)throw new Error("inflating: bad input")}else if(o!==s&&o!==l)throw new Error("inflating: "+t.msg);if((r||o===l)&&t.avail_in===e.length)throw new Error("inflating: bad input");t.next_out_index&&(512===t.next_out_index?f.push(new Uint8Array(i)):f.push(new Uint8Array(i.subarray(0,t.next_out_index)))),h+=t.next_out_index,a&&t.next_in_index>0&&t.next_in_index!=u&&(a(t.next_in_index),u=t.next_in_index)}while(t.avail_in>0||0===t.avail_out);return c=new Uint8Array(h),f.forEach(function(e){c.set(e,d),d+=e.length}),c}},e.flush=function(){t.inflateEnd()}}var s=0,l=1,c=2,f=-2,u=-3,d=-4,_=-5,h=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],p=1440,b=0,v=4,w=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],g=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],y=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],m=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],x=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],k=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],E=15;t.inflate_trees_fixed=function(e,t,n,i){return e[0]=9,t[0]=5,n[0]=w,i[0]=g,s};var S=0,R=1,U=2,A=3,I=4,P=5,D=6,T=7,z=8,O=9,F=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],B=0,C=1,L=2,M=3,j=4,W=5,H=6,N=7,G=8,Z=9,J=32,K=8,q=0,$=1,V=2,X=3,Y=4,Q=5,ee=6,te=7,ne=12,ie=13,re=[0,0,255,255];a.prototype={inflateInit:function(e){var t=this;return t.istate=new r,e||(e=15),t.istate.inflateInit(t,e)},inflate:function(e){var t=this;return t.istate?t.istate.inflate(t,e):f},inflateEnd:function(){var e=this;if(!e.istate)return f;var t=e.istate.inflateEnd(e);return e.istate=null,t},inflateSync:function(){var e=this;return e.istate?e.istate.inflateSync(e):f},inflateSetDictionary:function(e,t){var n=this;return n.istate?n.istate.inflateSetDictionary(n,e,t):f},read_byte:function(e){return this.next_in.subarray(e,e+1)[0]},read_buf:function(e,t){return this.next_in.subarray(e,e+t)}};var ae=e.zip||e;ae.Inflater=ae._jzlib_Inflater=o}(this),define("inflate",function(e){return function(){return e.zip}}(this)),define("readium_js_viewer/storage/ZipFileLoader",["zip","../workers/Messages","inflate"],function(e,t){return e.useWebWorkers=!1,ZipFileLoader=function(e){this.options=e},ZipFileLoader.prototype={init:function(t){if(this.entries)return void t();var n=this.options.buf;this.entries={};var i=this;e.createReader(new e.BlobReader(n),function(e){e.getEntries(function(e){for(var n=0;n<e.length;n++)e[n].directory||(i.entries[e[n].filename]=e[n]);t()})},this.options.error)},isZipFile:function(){return!0},getZipBlob:function(){return this.options.buf},loadFile:function(t,n){if(!this.entries)throw"you need to call ZipFileLoader.init first";var i=this.entries[t];i?i.getData(new e.BlobWriter,n):n(null)},loadAllFiles:function(t,n,i){if(!this.entries)throw"you need to call ZipFileLoader.init first";for(var r=this.entries,a=0;a<t.length;a++)delete r[t[a]];var o=[],s=function(){o.length&&setTimeout(l.bind(null,o.shift()),0)},l=function(t){t.getData(new e.BlobWriter,i.bind(null,s,t.filename))},c=this.options.buf,f=0,u=c.size>157286400?1:200;for(var d in r){var _=r[d];f++<n||(f<=n+u?l(_):o.push(_))}return f}},ZipFileLoader}),define("readium_js_viewer/storage/UnpackedDirLoader",[],function(){var e=function(e){this.files=e};return e.prototype={isZipFile:function(){return!1},loadFile:function(e,t){t(this.files[e])},loadAllFiles:function(e,t,n){for(var i=0;i<e.length;i++)delete this.files[e[i]];var r=0;for(var a in this.files)r++<t||setTimeout(n.bind(null,null,a,this.files[a]),0);return r}},e}),define("readium_js_viewer/ModuleConfig",["module"],function(e){var t="";if("undefined"!=typeof window){var n=window.location&&window.location.pathname?window.location.pathname:"";n=n.replace(/(.*)\/.*\.[x]?html$/,"$1"),n="/"==n.charAt(n.length-1)?n.substr(0,n.length-1):n,t=window.location?window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+n:""}var i=e.config();return{imagePathPrefix:i.imagePathPrefix||"",epubLibraryPath:i.epubLibraryPath||"epub_content/epub_library.json",canHandleUrl:i.canHandleUrl||!1,canHandleDirectory:i.canHandleDirectory||!1,epubReadingSystemUrl:i.epubReadingSystemUrl||"/EPUBREADINGSYSTEM.js",workerUrl:i.workerUrl||"scripts/readium-js-viewer_CLOUDAPP-WORKER.js",annotationCSSUrl:i.annotationCSSUrl||t+"/css/annotations.css",mathJaxUrl:i.mathJaxUrl||"scripts/mathjax/MathJax.js",jsLibRoot:i.jsLibRoot||"scripts/zip/",fonts:i.fonts||[],useSimpleLoader:i.useSimpleLoader||!1}}),function(e,t){"object"==typeof exports?module.exports=exports=t():"function"==typeof define&&define.amd?define("cryptoJs/core",[],t):e.CryptoJS=t()}(this,function(){var e=e||function(e,t){var n=Object.create||function(){function e(){}return function(t){var n;return e.prototype=t,n=new e,e.prototype=null,n}}(),i={},r=i.lib={},a=r.Base=function(){return{extend:function(e){var t=n(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),o=r.WordArray=a.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=void 0!=t?t:4*e.length},toString:function(e){return(e||l).stringify(this)},concat:function(e){var t=this.words,n=e.words,i=this.sigBytes,r=e.sigBytes;if(this.clamp(),i%4)for(var a=0;a<r;a++){var o=n[a>>>2]>>>24-a%4*8&255;t[i+a>>>2]|=o<<24-(i+a)%4*8}else for(var a=0;a<r;a+=4)t[i+a>>>2]=n[a>>>2];return this.sigBytes+=r,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=a.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n,i=[],r=0;r<t;r+=4){var a=function(t){var t=t,n=987654321,i=4294967295;return function(){n=36969*(65535&n)+(n>>16)&i,t=18e3*(65535&t)+(t>>16)&i;var r=(n<<16)+t&i;return r/=4294967296,(r+=.5)*(e.random()>.5?1:-1)}}(4294967296*(n||e.random()));n=987654071*a(),i.push(4294967296*a()|0)}return new o.init(i,t)}}),s=i.enc={},l=s.Hex={stringify:function(e){for(var t=e.words,n=e.sigBytes,i=[],r=0;r<n;r++){var a=t[r>>>2]>>>24-r%4*8&255;i.push((a>>>4).toString(16)),i.push((15&a).toString(16))}return i.join("")},parse:function(e){for(var t=e.length,n=[],i=0;i<t;i+=2)n[i>>>3]|=parseInt(e.substr(i,2),16)<<24-i%8*4;return new o.init(n,t/2)}},c=s.Latin1={stringify:function(e){for(var t=e.words,n=e.sigBytes,i=[],r=0;r<n;r++){var a=t[r>>>2]>>>24-r%4*8&255;i.push(String.fromCharCode(a))}return i.join("")},parse:function(e){for(var t=e.length,n=[],i=0;i<t;i++)n[i>>>2]|=(255&e.charCodeAt(i))<<24-i%4*8;return new o.init(n,t)}},f=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},u=r.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=f.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,i=n.words,r=n.sigBytes,a=this.blockSize,s=4*a,l=r/s;l=t?e.ceil(l):e.max((0|l)-this._minBufferSize,0);var c=l*a,f=e.min(4*c,r);if(c){for(var u=0;u<c;u+=a)this._doProcessBlock(i,u);var d=i.splice(0,c);n.sigBytes-=f}return new o.init(d,f)},clone:function(){var e=a.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),d=(r.Hasher=u.extend({cfg:a.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new d.HMAC.init(e,n).finalize(t)}}}),i.algo={});return i}(Math);return e}),define("cryptoJs",["cryptoJs/core"],function(e){return e}),function(e,t){"object"==typeof exports?module.exports=exports=t(require("./core")):"function"==typeof define&&define.amd?define("cryptoJs/sha1",["./core"],t):t(e.CryptoJS)}(this,function(e){return function(){var t=e,n=t.lib,i=n.WordArray,r=n.Hasher,a=t.algo,o=[],s=a.SHA1=r.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,i=n[0],r=n[1],a=n[2],s=n[3],l=n[4],c=0;c<80;c++){if(c<16)o[c]=0|e[t+c];else{var f=o[c-3]^o[c-8]^o[c-14]^o[c-16];o[c]=f<<1|f>>>31}var u=(i<<5|i>>>27)+l+o[c];u+=c<20?1518500249+(r&a|~r&s):c<40?1859775393+(r^a^s):c<60?(r&a|r&s|a&s)-1894007588:(r^a^s)-899497514,l=s,s=a,a=r<<30|r>>>2,r=i,i=u}n[0]=n[0]+i|0,n[1]=n[1]+r|0,n[2]=n[2]+a|0,n[3]=n[3]+s|0,n[4]=n[4]+l|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,i=8*e.sigBytes;return t[i>>>5]|=128<<24-i%32,t[14+(i+64>>>9<<4)]=Math.floor(n/4294967296),t[15+(i+64>>>9<<4)]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA1=r._createHelper(s),t.HmacSHA1=r._createHmacHelper(s)}(),e.SHA1}),define("readium_js/epub-fetch/encryption_handler",["cryptoJs/sha1"],function(e){var t=function(e){function t(e,t){var n=new FileReader;n.onload=function(){var e=this.result;t(new Uint8Array(e))},n.readAsArrayBuffer(e)}function n(e,n,i,r){t(e.slice(0,n),function(t){for(var a=i.length,o=0;o<n;o++)t[o]=t[o]^i[o%a];var s=new Blob([t],{type:e.type}),l=e.slice(n),c=new Blob([s,l],{type:e.type});r(c)})}function i(t,i){n(t,1040,e.uidHash,i)}function r(e){var t=/(urn:uuid:)?([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/i,n=t.exec(e),i=n[2]+n[3]+n[4]+n[5]+n[6];i&&32==i.length||console.error("Bad UUID format for ID :"+e);for(var r=[],a=0;a<16;a++){var o=i.substr(2*a,2),s=parseInt(o,16);r.push(s)}return r}function a(t,i){n(t,1024,r(e.uid),i)}var o=this,s={"http://www.idpf.org/2008/embedding":i,"http://ns.adobe.com/pdf/enc#RC":a};this.isEncryptionSpecified=function(){return e&&e.encryptions},this.getEncryptionMethodForRelativePath=function(t){return o.isEncryptionSpecified()?e.encryptions[t]:void 0},this.getDecryptionFunctionForRelativePath=function(e){var t=o.getEncryptionMethodForRelativePath(e);return t&&s[t]?s[t]:void 0}};return t.CreateEncryptionData=function(t,n){for(var i=unescape(encodeURIComponent(t.trim())),r=e(i),a=[],o=0;o<r.sigBytes;o++)a.push(r.words[o>>>2]>>>24-o%4*8&255);var s={uid:t,uidHash:a,encryptions:void 0};return $("EncryptedData",n).each(function(e,t){var n=$("EncryptionMethod",t).first().attr("Algorithm");$("CipherReference",t).each(function(e,t){var i=$(t).attr("URI");console.log("Encryption/obfuscation algorithm "+n+" specified for "+i),s.encryptions||(s.encryptions={}),s.encryptions[i]=n})}),s},t}),define("readium_js_viewer/workers/ContentTransformer",["../ModuleConfig","readium_js/epub-fetch/encryption_handler"],function(e,t){var n=function(e){return e.lastIndexOf(".xhtml")==e.length-".xhtml".length||e.lastIndexOf(".html")==e.length-".html".length},i=function(e){this.encryptionHandler=new t(e)};return i.prototype={transformContent:function(e,t,i){var r=this.encryptionHandler.getDecryptionFunctionForRelativePath(e);if(r)try{r(t,i)}catch(e){console.error(e),i(t)}else if(n(e)){var a=new FileReader,o=this;a.onload=function(){var e=o._transformXhtml(this.result);i(new Blob([e]))},a.readAsText(t)}else i(t)},_transformXhtml:function(t){var n=e.mathJaxUrl,i=e.epubReadingSystemUrl,r="";return i&&(r+='<script type="text/javascript" src="'+i+'"><\/script>'),n&&t.search(/<(\w+:|)(?=math)/)>=0&&(r+='<script type="text/javascript" src="'+n+'"><\/script>'),r?t.replace(/(<head[\s\S]*?>)/,"$1"+r):t}},i}),define("readium_js_viewer/workers/CloudLibraryWriter",["StorageManager","../storage/ZipFileLoader","../storage/UnpackedDirLoader","./Messages","./ContentTransformer"],function(e,t,n,i,r){var a=function(){};a.prototype={_getFullUrl:function(e,t){if(!t)return null;var n=e.split("/");return n.pop(),n.join("/")+("/"==t.charAt(0)?"":"/")+t},_saveLibraryIndex:function(t,n,i){for(var r=i.length;r--;)void 0===i[r].id&&i.splice(r,1);e.saveBookshelf("db://epub_library.json",i,t,n)},_saveEpubToIndex:function(t,n){var r=this;postMessage({msg:i.STORE_TEMP_BOOKSHELF,epubObj:n}),e.getFile("db://epub_library.json",function(e){var i=[];e&&(i=e),i.push(n),Array.prototype.push.apply(r.libraryData,i),r._saveLibraryIndex(function(){t.success(n)},t.error,i)},function(){console.log("error getting epub_content")})},_addEpub:function(t,n,i,r){var a=this.fileLoader,o=a.getZipBlob(),s=o.name,l=this,c=function(){console.log("package: "),console.log(JSON.stringify(n,null,4)),console.log("packagePath: "+i);var r={id:n.id,rootDir:s,packagePath:i,title:n.title,author:n.author,rootUrl:e.getPathUrl(s)};n.coverHref&&(r.coverPath=n.coverHref,r.coverHref=e.getPathUrl(s+"/"+l._getFullUrl(i,n.coverHref))),l._saveEpubToIndex(t,r)};e.saveFile("db://"+s,o,function(){a.loadFile("OEBPS/"+n.coverHref,function(t){e.saveFile("db://"+s+"/OEBPS/"+n.coverHref,t,c,function(e){console.log(e)})})},function(e){console.log(e)})},_replaceEpub:function(e,t,n){var i=this,r=function(t){i.deleteEpub(e,function(){i.callbacks.success(t)},i.callbacks.error)},a={success:r,error:this.callbacks.error,progress:this.callbacks.progress};this._addEpub(a,t,n)},_checkForConflict:function(e,t,n){for(var i=0;i<this.libraryData.length;i++)if(this.libraryData[i].id===e.id){var r=this._replaceEpub.bind(this,this.libraryData[i],e,t),a=this._addEpub.bind(this,this.callbacks,e,t);return void this.callbacks.overwrite(this.libraryData[i],r,a)}this._addEpub(this.callbacks,e,t,n)},_deleteEpubWithIndex:function(t,n,i){var r=this.libraryData[t];this.libraryData.splice(t,1),this._saveLibraryIndex(function(){e.deleteFile(r.rootDir,n,i)},i)},_loadFileAsString:function(e,t,n){var r=this.callbacks.error,a=new FileReader;this.fileLoader.loadFile(e,function(o){o?(a.onload=function(){t(this.result)},a.readAsText(o)):n?t(void 0):(r(i.ERROR_EPUB),console.error("Epub archive or directory missing a required  file: "+e))})},_findPackagePath:function(e,t){l=function(e){l=null,t(e.path)},postMessage({msg:i.FIND_PACKAGE,containerStr:e})},_parsePackageData:function(e,t,n){c=function(e){c=null,n(e.packageObj,e.encryptionData)},postMessage({msg:i.PARSE_PACKAGE,packageStr:e,encryptionStr:t})},_addEpubToLibrary:function(e){this.fileLoader=e;var t=this;this._loadFileAsString("META-INF/container.xml",function(e){t._findPackagePath(e,function(e){t._loadFileAsString(e,function(n){t._loadFileAsString("META-INF/encryption.xml",function(i){t._parsePackageData(n,i,function(n,i){t._checkForConflict(n,e,i)})},!0)})})})},deleteEpubWithId:function(e,t,n){for(var i=0;i<this.libraryData.length&&this.libraryData[i].rootDir!=e;i++);i<this.libraryData.length?this._deleteEpubWithIndex(i,t,n):t()},deleteEpub:function(e,t,n){for(var i=0;i<this.libraryData.length&&this.libraryData[i]!=e;i++);i<this.libraryData.length?this._deleteEpubWithIndex(i,t,n):t()},importZip:function(e,n){this.callbacks=n;var i=new t({buf:e,error:n.error});i.init(this._addEpubToLibrary.bind(this,i))},continueImportZip:function(e,n,i,r){this.callbacks=r,this.startAtIndex=n,this.rootDirName=i;var a=new t({buf:e,error:r.error});this._addEpubToLibrary(a)},importFileList:function(e,t){this.callbacks=t,this._addEpubToLibrary(new n(e))},importUrl:function(e,t){var n=new XMLHttpRequest;self=this,error=function(){t.error(i.ERROR_AJAX)},n.open("GET",e,!0),n.responseType="blob",n.onload=function(e){if(200==this.status){var n=new Blob([this.response],{type:"application/epub"});self.importZip(n,t)}else error()},n.onerror=error,n.send()}};var o,s,l,c,f=new a;return onmessage=function(t){var n=t.data,r=n.msg,a=function(){postMessage({msg:i.SUCCESS,libraryItems:f.libraryData})},u=function(e,t,n){postMessage({msg:i.PROGRESS,percent:e,progressType:t,progressData:n})},d=function(e,t){postMessage({msg:i.ERROR,errorMsg:e,errorData:t})},_=function(e,t,n){postMessage({msg:i.CONTINUE_IMPORT_ZIP,buf:e,index:t,rootDirName:n,libraryItems:f.libraryData})},h=function(e,t,n){postMessage({msg:i.OVERWRITE,item:e}),o=function(){o=null,s=null,t()},s=function(){o=null,s=null,n()}};switch(r){case i.IMPORT_ZIP:f.libraryData=n.libraryItems;var p=n.buf;e.initStorage(function(){f.importZip(p,{success:a,progress:u,error:d,overwrite:h,continueImport:_})},d);break;case i.CONTINUE_IMPORT_ZIP:f.libraryData=n.libraryItems;var p=n.buf,b=n.index,v=n.rootDirName;e.initStorage(function(){f.continueImportZip(p,b,v,{success:a,progress:u,error:d,overwrite:h,continueImport:_})},d);break;case i.DELETE_EPUB:f.libraryData=n.libraryItems;var w=n.id;e.initStorage(function(){f.deleteEpubWithId(w,a,d)},d);break;case i.IMPORT_DIR:f.libraryData=n.libraryItems;var g=n.files;e.initStorage(function(){f.importFileList(g,{success:a,progress:u,error:d,overwrite:h})},d);break;case i.IMPORT_URL:f.libraryData=n.libraryItems;var y=n.url;e.initStorage(function(){f.importUrl(y,{success:a,progress:u,error:d,overwrite:h})},d);break;case i.MIGRATE:e.initStorage(function(){var t=function(e,t){u(e,i.PROGRESS_MIGRATING,t)};e.migrateLegacyBooks(a,d,t)},d);case i.OVERWRITE_CONTINUE:o&&o(n);break;case i.OVERWRITE_SIDE_BY_SIDE:s&&s(n);break;case i.FIND_PACKAGE_RESPONSE:l&&l(n);break;case i.PARSE_PACKAGE_RESPONSE:c&&c(n)}},setTimeout(function(){postMessage({msg:i.READY})},30),f}),require(["readium_js_viewer/workers/CloudLibraryWriter"]);
//# sourceMappingURL=readium-js-viewer_CLOUDAPP-WORKER.js.map