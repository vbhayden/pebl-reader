let DEBUGGING=!1;function consoleLog(...e){DEBUGGING&&console.log(...e)}function consoleError(...e){DEBUGGING&&console.error(...e)}
/**
 * @license almond 0.3.3 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/almond/LICENSE
 */var requirejs,require,define;!function(e){var t,i,n,r,a={},o={},s={},l={},c=Object.prototype.hasOwnProperty,f=[].slice,u=/\.js$/;function d(e,t){return c.call(e,t)}function _(e,t){var i,n,r,a,o,l,c,f,d,_,h,p=t&&t.split("/"),b=s.map,v=b&&b["*"]||{};if(e){for(o=(e=e.split("/")).length-1,s.nodeIdCompat&&u.test(e[o])&&(e[o]=e[o].replace(u,"")),"."===e[0].charAt(0)&&p&&(e=p.slice(0,p.length-1).concat(e)),d=0;d<e.length;d++)if("."===(h=e[d]))e.splice(d,1),d-=1;else if(".."===h){if(0===d||1===d&&".."===e[2]||".."===e[d-1])continue;d>0&&(e.splice(d-1,2),d-=2)}e=e.join("/")}if((p||v)&&b){for(d=(i=e.split("/")).length;d>0;d-=1){if(n=i.slice(0,d).join("/"),p)for(_=p.length;_>0;_-=1)if((r=b[p.slice(0,_).join("/")])&&(r=r[n])){a=r,l=d;break}if(a)break;!c&&v&&v[n]&&(c=v[n],f=d)}!a&&c&&(a=c,l=f),a&&(i.splice(0,l,a),e=i.join("/"))}return e}function h(e,t){return function(){var n=f.call(arguments,0);return"string"!=typeof n[0]&&1===n.length&&n.push(null),i.apply(void 0,n.concat([e,t]))}}function p(e){return function(t){a[e]=t}}function b(e){if(d(o,e)){var i=o[e];delete o[e],l[e]=!0,t.apply(void 0,i)}if(!d(a,e)&&!d(l,e))throw new Error("No "+e);return a[e]}function v(e){var t,i=e?e.indexOf("!"):-1;return i>-1&&(t=e.substring(0,i),e=e.substring(i+1,e.length)),[t,e]}function w(e){return e?v(e):[]}function g(e){return function(){return s&&s.config&&s.config[e]||{}}}n=function(e,t){var i,n,r=v(e),a=r[0],o=t[1];return e=r[1],a&&(i=b(a=_(a,o))),a?e=i&&i.normalize?i.normalize(e,(n=o,function(e){return _(e,n)})):_(e,o):(a=(r=v(e=_(e,o)))[0],e=r[1],a&&(i=b(a))),{f:a?a+"!"+e:e,n:e,pr:a,p:i}},r={require:function(e){return h(e)},exports:function(e){var t=a[e];return void 0!==t?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:g(e)}}},t=function(e,t,i,s){var c,f,u,_,v,g,y,m=[],x=typeof i;if(g=w(s=s||e),"undefined"===x||"function"===x){for(t=!t.length&&i.length?["require","exports","module"]:t,v=0;v<t.length;v+=1)if("require"===(f=(_=n(t[v],g)).f))m[v]=r.require(e);else if("exports"===f)m[v]=r.exports(e),y=!0;else if("module"===f)c=m[v]=r.module(e);else if(d(a,f)||d(o,f)||d(l,f))m[v]=b(f);else{if(!_.p)throw new Error(e+" missing "+f);_.p.load(_.n,h(s,!0),p(f),{}),m[v]=a[f]}u=i?i.apply(a[e],m):void 0,e&&(c&&void 0!==c.exports&&c.exports!==a[e]?a[e]=c.exports:void 0===u&&y||(a[e]=u))}else e&&(a[e]=i)},requirejs=require=i=function(e,a,o,l,c){if("string"==typeof e)return r[e]?r[e](a):b(n(e,w(a)).f);if(!e.splice){if((s=e).deps&&i(s.deps,s.callback),!a)return;a.splice?(e=a,a=o,o=null):e=void 0}return a=a||function(){},"function"==typeof o&&(o=l,l=c),l?t(void 0,e,a,o):setTimeout((function(){t(void 0,e,a,o)}),4),i},i.config=function(e){return i(e)},requirejs._defined=a,(define=function(e,t,i){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");t.splice||(i=t,t=[]),d(a,e)||d(o,e)||(o[e]=[e,t,i])}).amd={jQuery:!0}}(),define("readium-js-viewer_CLOUDAPP-WORKER",(function(){}));var currentURL=self.location?self.location.protocol+"//"+self.location.hostname+(self.location.port?":"+self.location.port:"")+(self.location.pathname?self.location.pathname:""):"";console.log(currentURL),console.log(self.location.origin),require.config({waitSeconds:0,config:{"readium_js_viewer/ModuleConfig":{mathJaxUrl:self.location.origin+"/scripts/mathjax/MathJax.js",fonts:[],annotationCSSUrl:self.location.origin+"/css/annotations.css",jsLibRoot:"/scripts/zip/",useSimpleLoader:!0,epubLibraryPath:void 0,imagePathPrefix:void 0,canHandleUrl:!1,canHandleDirectory:!0,workerUrl:"/scripts/readium-js-viewer_CLOUD-WORKER.js",epubReadingSystemUrl:self.location.origin+"/scripts/epubReadingSystem.js"}}}),define("readium_js_viewer_RJS-CONFIG",(function(){})),define("StorageManager",[],(function(){var e,t=indexedDB,i=(IDBTransaction,IDBKeyRange,function(t,i,n,r){var a=e.transaction(["books"],"readonly").objectStore("books").get(t);a.onerror=function(e){null!=n&&n()},a.onsuccess=function(e){if(null!=i&&e.target.result){var t=e.target.result.content,n=e.target.result.id.split("/").pop();r&&t instanceof ArrayBuffer?function(e,t,i){var n=new Blob([new Uint8Array(e)]),r=new File([n],t);i(r)}(t,n,(function(e){i(e)})):i(e.target.result.content)}else i()}});var n=function(t,i,n,a){var o={id:t,content:i},s=e.transaction(["books"],"readwrite").objectStore("books").put(r(o));s.onerror=function(e){null!=a&&a(e)},s.onsuccess=function(e){null!=n&&n(e.target.result)}};function r(e){var t=typeof e;if("object"==t){for(var i in e)if(e.hasOwnProperty(i)){var n=e[i],a=typeof n;if("function"==a)delete e[i];else if("array"==a)for(var o=0;o<n.length;o++)r(n[o]);else"object"==a&&r(n)}}else if("array"==t)for(o=0;o<e.length;o++)r(e[o]);return e}var a=function(){var e=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"];if(navigator.platform)for(;e.length;)if(navigator.platform===e.pop())return!0;return!1}();return{saveFile:function(e,t,i,r){a?function(e,t){var i,n=new FileReader;n.onload=function(e){i=e.target.result,t(i)},n.readAsArrayBuffer(e)}(t,(function(t){n(e,t,i,r)})):n(e,t,i,r)},saveBookshelf:function(t,i,n,a){!function(t,i,n,a){var o={id:t,content:i},s=e.transaction(["books"],"readwrite").objectStore("books").put(r(o));s.onerror=function(e){null!=a&&a(e)},s.onsuccess=function(e){null!=n&&n(e.target.result)}}(t,i,n,a)},saveTemporaryBookshelf:function(e){!function(e){window.tempBookshelf&&window.tempBookshelf.push(e)}(e)},getFile:function(e,t,n){i(e,t,n,a)},deleteFile:function(t,i,n){!function(t,i,n){var r=e.transaction(["books"],"readwrite").objectStore("books").delete(t);r.onerror=function(e){null!=n&&n()},r.onsuccess=function(e){null!=i&&i()}}(t,i,n)},getPathUrl:function(e){return"db://"+e},initStorage:function(i,n){var r=t.open("bookshelf",2);r.onupgradeneeded=function(t){for(var i=(e=t.target.result).objectStoreNames,n=0;n<i.length;n++)e.deleteObjectStore(i[n]);e.createObjectStore("books",{keyPath:"id"})},r.onsuccess=function(t){e=t.target.result,i()},r.onerror=function(e){}}}})),function(e){"use strict";var t,i="File format is not recognized.",n="Error while reading zip file.";try{t=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}function r(){this.crc=-1}function a(){}function o(e,t){var i,n;return i=new ArrayBuffer(e),n=new Uint8Array(i),t&&n.set(t,0),{buffer:i,array:n,view:new DataView(i)}}function s(){}function l(e){var t,i=this;i.size=0,i.init=function(n,r){var a=new Blob([e],{type:"text/plain"});(t=new f(a)).init((function(){i.size=t.size,n()}),r)},i.readUint8Array=function(e,i,n,r){t.readUint8Array(e,i,n,r)}}function c(t){var i,n=this;n.size=0,n.init=function(e){for(var r=t.length;"="==t.charAt(r-1);)r--;i=t.indexOf(",")+1,n.size=Math.floor(.75*(r-i)),e()},n.readUint8Array=function(n,r,a){var s,l=o(r),c=4*Math.floor(n/3),f=4*Math.ceil((n+r)/3),u=e.atob(t.substring(c+i,f+i)),d=n-3*Math.floor(c/4);for(s=d;s<d+r;s++)l.array[s-d]=u.charCodeAt(s);a(l.array)}}function f(e){var t=this;t.size=0,t.init=function(i){t.size=e.size,i()},t.readUint8Array=function(t,i,n,r){var a=new FileReader;a.onload=function(e){n(new Uint8Array(e.target.result))},a.onerror=r;try{a.readAsArrayBuffer(function(e,t,i){if(t<0||i<0||t+i>e.size)throw new RangeError("offset:"+t+", length:"+i+", size:"+e.size);return e.slice?e.slice(t,t+i):e.webkitSlice?e.webkitSlice(t,t+i):e.mozSlice?e.mozSlice(t,t+i):e.msSlice?e.msSlice(t,t+i):void 0}(e,t,i))}catch(e){r(e)}}}function u(){}function d(e){var i;this.init=function(e){i=new Blob([],{type:"text/plain"}),e()},this.writeUint8Array=function(e,n){i=new Blob([i,t?e:e.buffer],{type:"text/plain"}),n()},this.getData=function(t,n){var r=new FileReader;r.onload=function(e){t(e.target.result)},r.onerror=n,r.readAsText(i,e)}}function _(t){var i="",n="";this.init=function(e){i+="data:"+(t||"")+";base64,",e()},this.writeUint8Array=function(t,r){var a,o=n.length,s=n;for(n="",a=0;a<3*Math.floor((o+t.length)/3)-o;a++)s+=String.fromCharCode(t[a]);for(;a<t.length;a++)n+=String.fromCharCode(t[a]);s.length>2?i+=e.btoa(s):n=s,r()},this.getData=function(t){t(i+e.btoa(n))}}function h(e){var i=[];this.init=function(e){e()},this.writeUint8Array=function(e,n){i.push(t?e:e.buffer),n()},this.getData=function(t){t(new Blob(i,{type:e}))}}function p(e,t,i,n,r,a,o,s,l,c){var f,u,d,_=0,h=t.sn;function p(){e.removeEventListener("message",b,!1),s(u,d)}function b(t){var i=t.data,r=i.data,s=i.error;if(s)return s.toString=function(){return"Error: "+this.message},void l(s);if(i.sn===h)switch("number"==typeof i.codecTime&&(e.codecTime+=i.codecTime),"number"==typeof i.crcTime&&(e.crcTime+=i.crcTime),i.type){case"append":r?(u+=r.length,n.writeUint8Array(r,(function(){v()}),c)):v();break;case"flush":d=i.crc,r?(u+=r.length,n.writeUint8Array(r,(function(){p()}),c)):p();break;case"progress":o&&o(f+i.loaded,a);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",i)}}function v(){(f=524288*_)<=a?i.readUint8Array(r+f,Math.min(524288,a-f),(function(i){o&&o(f,a);var n=0===f?t:{sn:h};n.type="append",n.data=i;try{e.postMessage(n,[i.buffer])}catch(t){e.postMessage(n)}_++}),l):e.postMessage({sn:h,type:"flush"})}u=0,e.addEventListener("message",b,!1),v()}function b(e,t,i,n,a,o,s,l,c,f){var u,d=0,_=0,h="input"===o,p="output"===o,b=new r;!function r(){var o;if((u=524288*d)<a)t.readUint8Array(n+u,Math.min(524288,a-u),(function(t){var n;try{n=e.append(t,(function(e){s&&s(u+e,a)}))}catch(e){return void c(e)}n?(_+=n.length,i.writeUint8Array(n,(function(){d++,setTimeout(r,1)}),f),p&&b.append(n)):(d++,setTimeout(r,1)),h&&b.append(t),s&&s(u,a)}),c);else{try{o=e.flush()}catch(e){return void c(e)}o?(p&&b.append(o),_+=o.length,i.writeUint8Array(o,(function(){l(_,b.get())}),f)):l(_,b.get())}}()}function v(t,i,n,r,o,s,l,c,f,u,d){e.zip.useWebWorkers&&l?p(t,{sn:i,codecClass:"NOOP",crcType:"input"},n,r,o,s,f,c,u,d):b(new a,n,r,o,s,"input",f,c,u,d)}function w(e){var t,i,n="",r=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(t=0;t<e.length;t++)n+=(i=255&e.charCodeAt(t))>127?r[i-128]:String.fromCharCode(i);return n}function g(e){return decodeURIComponent(escape(e))}function y(e){var t,i="";for(t=0;t<e.length;t++)i+=String.fromCharCode(e[t]);return i}function m(e,t,i,n,r){e.version=t.view.getUint16(i,!0),e.bitFlag=t.view.getUint16(i+2,!0),e.compressionMethod=t.view.getUint16(i+4,!0),e.lastModDateRaw=t.view.getUint32(i+6,!0),e.lastModDate=function(e){var t=(4294901760&e)>>16,i=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&i)>>11,(2016&i)>>5,2*(31&i),0)}catch(e){}}(e.lastModDateRaw),1!=(1&e.bitFlag)?((n||8!=(8&e.bitFlag))&&(e.crc32=t.view.getUint32(i+10,!0),e.compressedSize=t.view.getUint32(i+14,!0),e.uncompressedSize=t.view.getUint32(i+18,!0)),4294967295!==e.compressedSize&&4294967295!==e.uncompressedSize?(e.filenameLength=t.view.getUint16(i+22,!0),e.extraFieldLength=t.view.getUint16(i+24,!0)):r("File is using Zip64 (4gb+ file size).")):r("File contains encrypted entry.")}function x(t,r,a){var s=0;function l(){}l.prototype.getData=function(n,r,l,c){var f=this;function u(e,t){c&&!function(e){var t=o(4);return t.view.setUint32(0,e),f.crc32==t.view.getUint32(0)}(t)?a("CRC failed."):n.getData((function(e){r(e)}))}function d(e){a(e||"Error while reading file data.")}function _(e){a(e||"Error while writing file data.")}t.readUint8Array(f.offset,30,(function(r){var h,w=o(r.length,r);1347093252==w.view.getUint32(0)?(m(f,w,4,!1,a),h=f.offset+30+f.filenameLength+f.extraFieldLength,n.init((function(){0===f.compressionMethod?v(f._worker,s++,t,n,h,f.compressedSize,c,u,l,d,_):function(t,i,n,r,a,o,s,l,c,f,u){var d=s?"output":"none";e.zip.useWebWorkers?p(t,{sn:i,codecClass:"Inflater",crcType:d},n,r,a,o,c,l,f,u):b(new e.zip.Inflater,n,r,a,o,d,c,l,f,u)}(f._worker,s++,t,n,h,f.compressedSize,c,u,l,d,_)}),_)):a(i)}),d)};var c={getEntries:function(e){var r=this._worker;!function(e){if(t.size<22)a(i);else{r(22,(function(){r(Math.min(65558,t.size),(function(){a(i)}))}))}function r(i,r){t.readUint8Array(t.size-i,i,(function(t){for(var i=t.length-22;i>=0;i--)if(80===t[i]&&75===t[i+1]&&5===t[i+2]&&6===t[i+3])return void e(new DataView(t.buffer,i,22));r()}),(function(){a(n)}))}}((function(s){var c,f;c=s.getUint32(16,!0),f=s.getUint16(8,!0),c<0||c>=t.size?a(i):t.readUint8Array(c,t.size-c,(function(t){var n,s,c,u,d=0,_=[],h=o(t.length,t);for(n=0;n<f;n++){if((s=new l)._worker=r,1347092738!=h.view.getUint32(d))return void a(i);m(s,h,d+6,!0,a),s.commentLength=h.view.getUint16(d+32,!0),s.directory=16==(16&h.view.getUint8(d+38)),s.offset=h.view.getUint32(d+42,!0),c=y(h.array.subarray(d+46,d+46+s.filenameLength)),s.filename=2048==(2048&s.bitFlag)?g(c):w(c),s.directory||"/"!=s.filename.charAt(s.filename.length-1)||(s.directory=!0),u=y(h.array.subarray(d+46+s.filenameLength+s.extraFieldLength,d+46+s.filenameLength+s.extraFieldLength+s.commentLength)),s.comment=2048==(2048&s.bitFlag)?g(u):w(u),_.push(s),d+=46+s.filenameLength+s.extraFieldLength+s.commentLength}e(_)}),(function(){a(n)}))}))},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null),e&&e()},_worker:null};e.zip.useWebWorkers?U("inflater",(function(e){c._worker=e,r(c)}),(function(e){a(e)})):r(c)}function k(e){return unescape(encodeURIComponent(e))}function E(e){var t,i=[];for(t=0;t<e.length;t++)i.push(e.charCodeAt(t));return i}function S(t,i,n,r){var a={},s=[],l=0,c=0;function f(e){n(e||"Error while writing zip file.")}function u(e){n(e||"Error while reading file data.")}var d={add:function(i,d,_,h,w){var g,y,m,x=this._worker;function S(e,i){var n=o(16);l+=e||0,n.view.setUint32(0,1347094280),void 0!==i&&(g.view.setUint32(10,i,!0),n.view.setUint32(4,i,!0)),d&&(n.view.setUint32(8,e,!0),g.view.setUint32(14,e,!0),n.view.setUint32(12,d.size,!0),g.view.setUint32(18,d.size,!0)),t.writeUint8Array(n.array,(function(){l+=16,_()}),f)}function R(){w=w||{},i=i.trim(),w.directory&&"/"!=i.charAt(i.length-1)&&(i+="/"),a.hasOwnProperty(i)?n("File already exists."):(y=E(k(i)),s.push(i),function(e){var n;m=w.lastModDate||new Date,g=o(26),a[i]={headerArray:g.array,directory:w.directory,filename:y,offset:l,comment:E(k(w.comment||""))},g.view.setUint32(0,335546376),w.version&&g.view.setUint8(0,w.version),r||0===w.level||w.directory||g.view.setUint16(4,2048),g.view.setUint16(6,(m.getHours()<<6|m.getMinutes())<<5|m.getSeconds()/2,!0),g.view.setUint16(8,(m.getFullYear()-1980<<4|m.getMonth()+1)<<5|m.getDate(),!0),g.view.setUint16(22,y.length,!0),(n=o(30+y.length)).view.setUint32(0,1347093252),n.array.set(g.array,4),n.array.set(y,30),l+=n.array.length,t.writeUint8Array(n.array,e,f)}((function(){d?r||0===w.level?v(x,c++,d,t,0,d.size,!0,S,h,u,f):function(t,i,n,r,a,o,s,l,c){e.zip.useWebWorkers?p(t,{sn:i,options:{level:a},codecClass:"Deflater",crcType:"input"},n,r,0,n.size,s,o,l,c):b(new e.zip.Deflater,n,r,0,n.size,"input",s,o,l,c)}(x,c++,d,t,w.level,S,h,u,f):S()})))}d?d.init(R,u):R()},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null);var i,n,r,c=0,u=0;for(n=0;n<s.length;n++)c+=46+(r=a[s[n]]).filename.length+r.comment.length;for(i=o(c+22),n=0;n<s.length;n++)r=a[s[n]],i.view.setUint32(u,1347092738),i.view.setUint16(u+4,5120),i.array.set(r.headerArray,u+6),i.view.setUint16(u+32,r.comment.length,!0),r.directory&&i.view.setUint8(u+38,16),i.view.setUint32(u+42,r.offset,!0),i.array.set(r.filename,u+46),i.array.set(r.comment,u+46+r.filename.length),u+=46+r.filename.length+r.comment.length;i.view.setUint32(u,1347093766),i.view.setUint16(u+8,s.length,!0),i.view.setUint16(u+10,s.length,!0),i.view.setUint32(u+12,c,!0),i.view.setUint32(u+16,l,!0),t.writeUint8Array(i.array,(function(){t.getData(e)}),f)},_worker:null};e.zip.useWebWorkers?U("deflater",(function(e){d._worker=e,i(d)}),(function(e){n(e)})):i(d)}r.prototype.append=function(e){for(var t=0|this.crc,i=this.table,n=0,r=0|e.length;n<r;n++)t=t>>>8^i[255&(t^e[n])];this.crc=t},r.prototype.get=function(){return~this.crc},r.prototype.table=function(){var e,t,i,n=[];for(e=0;e<256;e++){for(i=e,t=0;t<8;t++)1&i?i=i>>>1^3988292384:i>>>=1;n[e]=i}return n}(),a.prototype.append=function(e,t){return e},a.prototype.flush=function(){},l.prototype=new s,l.prototype.constructor=l,c.prototype=new s,c.prototype.constructor=c,f.prototype=new s,f.prototype.constructor=f,u.prototype.getData=function(e){e(this.data)},d.prototype=new u,d.prototype.constructor=d,_.prototype=new u,_.prototype.constructor=_,h.prototype=new u,h.prototype.constructor=h;var R={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};function U(t,i,n){if(null===e.zip.workerScripts||null===e.zip.workerScriptsPath){var r,a,o;if(e.zip.workerScripts){if(r=e.zip.workerScripts[t],!Array.isArray(r))return void n(new Error("zip.workerScripts."+t+" is not an array!"));a=r,o=document.createElement("a"),r=a.map((function(e){return o.href=e,o.href}))}else(r=R[t].slice(0))[0]=(e.zip.workerScriptsPath||"")+r[0];var s=new Worker(r[0]);s.codecTime=s.crcTime=0,s.postMessage({type:"importScripts",scripts:r.slice(1)}),s.addEventListener("message",(function e(t){var r=t.data;if(r.error)return s.terminate(),void n(r.error);"importScripts"===r.type&&(s.removeEventListener("message",e),s.removeEventListener("error",l),i(s))})),s.addEventListener("error",l)}else n(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));function l(e){s.terminate(),n(e)}}function A(e){console.error(e)}e.zip={Reader:s,Writer:u,BlobReader:f,Data64URIReader:c,TextReader:l,BlobWriter:h,Data64URIWriter:_,TextWriter:d,createReader:function(e,t,i){i=i||A,e.init((function(){x(e,t,i)}),i)},createWriter:function(e,t,i,n){i=i||A,n=!!n,e.init((function(){S(e,t,i,n)}),i)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(this),define("zip",function(e){return function(){return e.zip}}(this)),define("readium_js_viewer/workers/Messages",[],(function(){return{IMPORT_ZIP:0,OVERWRITE_CONTINUE:1,FIND_PACKAGE_RESPONSE:2,PARSE_PACKAGE_RESPONSE:3,DELETE_EPUB:4,IMPORT_DIR:5,IMPORT_URL:6,MIGRATE:7,OVERWRITE_SIDE_BY_SIDE:8,CONTINUE_IMPORT_ZIP:9,SUCCESS:100,PROGRESS:101,ERROR:102,OVERWRITE:103,FIND_PACKAGE:104,PARSE_PACKAGE:105,PROGRESS_EXTRACTING:200,PROGRESS_WRITING:201,PROGRESS_DELETING:202,PROGRESS_MIGRATING:203,ERROR_STORAGE:300,ERROR_EPUB:301,ERROR_AJAX:302,ERROR_PACKAGE_PARSE:303,READY:400,STORE_TEMP_BOOKSHELF:500}})),function(e){"use strict";var t=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],i=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],n=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],s=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];function l(){var e,t,i,n,l,c;function f(e,t,r,a,o,s,f,u,d,_,h){var p,b,v,w,g,y,m,x,k,E,S,R,U,A,I;E=0,g=r;do{i[e[t+E]]++,E++,g--}while(0!==g);if(i[0]==r)return f[0]=-1,u[0]=0,0;for(x=u[0],y=1;y<=15&&0===i[y];y++);for(m=y,x<y&&(x=y),g=15;0!==g&&0===i[g];g--);for(v=g,x>g&&(x=g),u[0]=x,A=1<<y;y<g;y++,A<<=1)if((A-=i[y])<0)return-3;if((A-=i[g])<0)return-3;for(i[g]+=A,c[1]=y=0,E=1,U=2;0!=--g;)c[U]=y+=i[E],U++,E++;g=0,E=0;do{0!==(y=e[t+E])&&(h[c[y]++]=g),E++}while(++g<r);for(r=c[v],c[0]=g=0,E=0,w=-1,R=-x,l[0]=0,S=0,I=0;m<=v;m++)for(p=i[m];0!=p--;){for(;m>R+x;){if(w++,I=(I=v-(R+=x))>x?x:I,(b=1<<(y=m-R))>p+1&&(b-=p+1,U=m,y<I))for(;++y<I&&!((b<<=1)<=i[++U]);)b-=i[U];if(I=1<<y,_[0]+I>1440)return-3;l[w]=S=_[0],_[0]+=I,0!==w?(c[w]=g,n[0]=y,n[1]=x,y=g>>>R-x,n[2]=S-l[w-1]-y,d.set(n,3*(l[w-1]+y))):f[0]=S}for(n[1]=m-R,E>=r?n[0]=192:h[E]<a?(n[0]=h[E]<256?0:96,n[2]=h[E++]):(n[0]=s[h[E]-a]+16+64,n[2]=o[h[E++]-a]),b=1<<m-R,y=g>>>R;y<I;y+=b)d.set(n,3*(S+y));for(y=1<<m-1;0!=(g&y);y>>>=1)g^=y;for(g^=y,k=(1<<R)-1;(g&k)!=c[w];)w--,k=(1<<(R-=x))-1}return 0!==A&&1!=v?-5:0}function u(r){var a;for(e||(e=[],t=[],i=new Int32Array(16),n=[],l=new Int32Array(15),c=new Int32Array(16)),t.length<r&&(t=[]),a=0;a<r;a++)t[a]=0;for(a=0;a<16;a++)i[a]=0;for(a=0;a<3;a++)n[a]=0;l.set(i.subarray(0,15),0),c.set(i.subarray(0,16),0)}this.inflate_trees_bits=function(i,n,r,a,o){var s;return u(19),e[0]=0,-3==(s=f(i,0,19,19,null,null,r,n,a,e,t))?o.msg="oversubscribed dynamic bit lengths tree":-5!=s&&0!==n[0]||(o.msg="incomplete dynamic bit lengths tree",s=-3),s},this.inflate_trees_dynamic=function(i,n,l,c,d,_,h,p,b){var v;return u(288),e[0]=0,0!=(v=f(l,0,i,257,r,a,_,c,p,e,t))||0===c[0]?(-3==v?b.msg="oversubscribed literal/length tree":-4!=v&&(b.msg="incomplete literal/length tree",v=-3),v):(u(288),0!=(v=f(l,i,n,0,o,s,h,d,p,e,t))||0===d[0]&&i>257?(-3==v?b.msg="oversubscribed distance tree":-5==v?(b.msg="incomplete distance tree",v=-3):-4!=v&&(b.msg="empty distance tree with lengths",v=-3),v):0)}}l.inflate_trees_fixed=function(e,t,r,a){return e[0]=9,t[0]=5,r[0]=i,a[0]=n,0};function c(){var e,i,n,r,a=0,o=0,s=0,l=0,c=0,f=0,u=0,d=0,_=0,h=0;function p(e,i,n,r,a,o,s,l){var c,f,u,d,_,h,p,b,v,w,g,y,m,x,k,E;p=l.next_in_index,b=l.avail_in,_=s.bitb,h=s.bitk,w=(v=s.write)<s.read?s.read-v-1:s.end-v,g=t[e],y=t[i];do{for(;h<20;)b--,_|=(255&l.read_byte(p++))<<h,h+=8;if(0!==(d=(f=n)[E=3*((u=r)+(c=_&g))]))for(;;){if(_>>=f[E+1],h-=f[E+1],0!=(16&d)){for(d&=15,m=f[E+2]+(_&t[d]),_>>=d,h-=d;h<15;)b--,_|=(255&l.read_byte(p++))<<h,h+=8;for(d=(f=a)[E=3*((u=o)+(c=_&y))];;){if(_>>=f[E+1],h-=f[E+1],0!=(16&d)){for(d&=15;h<d;)b--,_|=(255&l.read_byte(p++))<<h,h+=8;if(x=f[E+2]+(_&t[d]),_>>=d,h-=d,w-=m,v>=x)v-(k=v-x)>0&&2>v-k?(s.window[v++]=s.window[k++],s.window[v++]=s.window[k++],m-=2):(s.window.set(s.window.subarray(k,k+2),v),v+=2,k+=2,m-=2);else{k=v-x;do{k+=s.end}while(k<0);if(m>(d=s.end-k)){if(m-=d,v-k>0&&d>v-k)do{s.window[v++]=s.window[k++]}while(0!=--d);else s.window.set(s.window.subarray(k,k+d),v),v+=d,k+=d,d=0;k=0}}if(v-k>0&&m>v-k)do{s.window[v++]=s.window[k++]}while(0!=--m);else s.window.set(s.window.subarray(k,k+m),v),v+=m,k+=m,m=0;break}if(0!=(64&d))return l.msg="invalid distance code",b+=m=h>>3<(m=l.avail_in-b)?h>>3:m,p-=m,h-=m<<3,s.bitb=_,s.bitk=h,l.avail_in=b,l.total_in+=p-l.next_in_index,l.next_in_index=p,s.write=v,-3;c+=f[E+2],d=f[E=3*(u+(c+=_&t[d]))]}break}if(0!=(64&d))return 0!=(32&d)?(b+=m=h>>3<(m=l.avail_in-b)?h>>3:m,p-=m,h-=m<<3,s.bitb=_,s.bitk=h,l.avail_in=b,l.total_in+=p-l.next_in_index,l.next_in_index=p,s.write=v,1):(l.msg="invalid literal/length code",b+=m=h>>3<(m=l.avail_in-b)?h>>3:m,p-=m,h-=m<<3,s.bitb=_,s.bitk=h,l.avail_in=b,l.total_in+=p-l.next_in_index,l.next_in_index=p,s.write=v,-3);if(c+=f[E+2],0===(d=f[E=3*(u+(c+=_&t[d]))])){_>>=f[E+1],h-=f[E+1],s.window[v++]=f[E+2],w--;break}}else _>>=f[E+1],h-=f[E+1],s.window[v++]=f[E+2],w--}while(w>=258&&b>=10);return b+=m=h>>3<(m=l.avail_in-b)?h>>3:m,p-=m,h-=m<<3,s.bitb=_,s.bitk=h,l.avail_in=b,l.total_in+=p-l.next_in_index,l.next_in_index=p,s.write=v,0}this.init=function(t,a,o,s,l,c){e=0,u=t,d=a,n=o,_=s,r=l,h=c,i=null},this.proc=function(b,v,w){var g,y,m,x,k,E,S,R=0,U=0,A=0;for(A=v.next_in_index,x=v.avail_in,R=b.bitb,U=b.bitk,E=(k=b.write)<b.read?b.read-k-1:b.end-k;;)switch(e){case 0:if(E>=258&&x>=10&&(b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,w=p(u,d,n,_,r,h,b,v),A=v.next_in_index,x=v.avail_in,R=b.bitb,U=b.bitk,E=(k=b.write)<b.read?b.read-k-1:b.end-k,0!=w)){e=1==w?7:9;break}s=u,i=n,o=_,e=1;case 1:for(g=s;U<g;){if(0===x)return b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);w=0,x--,R|=(255&v.read_byte(A++))<<U,U+=8}if(R>>>=i[(y=3*(o+(R&t[g])))+1],U-=i[y+1],0===(m=i[y])){l=i[y+2],e=6;break}if(0!=(16&m)){c=15&m,a=i[y+2],e=2;break}if(0==(64&m)){s=m,o=y/3+i[y+2];break}if(0!=(32&m)){e=7;break}return e=9,v.msg="invalid literal/length code",w=-3,b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);case 2:for(g=c;U<g;){if(0===x)return b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);w=0,x--,R|=(255&v.read_byte(A++))<<U,U+=8}a+=R&t[g],R>>=g,U-=g,s=d,i=r,o=h,e=3;case 3:for(g=s;U<g;){if(0===x)return b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);w=0,x--,R|=(255&v.read_byte(A++))<<U,U+=8}if(R>>=i[(y=3*(o+(R&t[g])))+1],U-=i[y+1],0!=(16&(m=i[y]))){c=15&m,f=i[y+2],e=4;break}if(0==(64&m)){s=m,o=y/3+i[y+2];break}return e=9,v.msg="invalid distance code",w=-3,b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);case 4:for(g=c;U<g;){if(0===x)return b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);w=0,x--,R|=(255&v.read_byte(A++))<<U,U+=8}f+=R&t[g],R>>=g,U-=g,e=5;case 5:for(S=k-f;S<0;)S+=b.end;for(;0!==a;){if(0===E&&(k==b.end&&0!==b.read&&(E=(k=0)<b.read?b.read-k-1:b.end-k),0===E&&(b.write=k,w=b.inflate_flush(v,w),E=(k=b.write)<b.read?b.read-k-1:b.end-k,k==b.end&&0!==b.read&&(E=(k=0)<b.read?b.read-k-1:b.end-k),0===E)))return b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);b.window[k++]=b.window[S++],E--,S==b.end&&(S=0),a--}e=0;break;case 6:if(0===E&&(k==b.end&&0!==b.read&&(E=(k=0)<b.read?b.read-k-1:b.end-k),0===E&&(b.write=k,w=b.inflate_flush(v,w),E=(k=b.write)<b.read?b.read-k-1:b.end-k,k==b.end&&0!==b.read&&(E=(k=0)<b.read?b.read-k-1:b.end-k),0===E)))return b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);w=0,b.window[k++]=l,E--,e=0;break;case 7:if(U>7&&(U-=8,x++,A--),b.write=k,w=b.inflate_flush(v,w),E=(k=b.write)<b.read?b.read-k-1:b.end-k,b.read!=b.write)return b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);e=8;case 8:return w=1,b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);case 9:return w=-3,b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w);default:return w=-2,b.bitb=R,b.bitk=U,v.avail_in=x,v.total_in+=A-v.next_in_index,v.next_in_index=A,b.write=k,b.inflate_flush(v,w)}},this.free=function(){}}var f=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function u(e,i){var n,r=this,a=0,o=0,s=0,u=0,d=[0],_=[0],h=new c,p=0,b=new Int32Array(4320),v=new l;r.bitk=0,r.bitb=0,r.window=new Uint8Array(i),r.end=i,r.read=0,r.write=0,r.reset=function(e,t){t&&(t[0]=0),6==a&&h.free(e),a=0,r.bitk=0,r.bitb=0,r.read=r.write=0},r.reset(e,null),r.inflate_flush=function(e,t){var i,n,a;return n=e.next_out_index,(i=((a=r.read)<=r.write?r.write:r.end)-a)>e.avail_out&&(i=e.avail_out),0!==i&&-5==t&&(t=0),e.avail_out-=i,e.total_out+=i,e.next_out.set(r.window.subarray(a,a+i),n),n+=i,(a+=i)==r.end&&(a=0,r.write==r.end&&(r.write=0),(i=r.write-a)>e.avail_out&&(i=e.avail_out),0!==i&&-5==t&&(t=0),e.avail_out-=i,e.total_out+=i,e.next_out.set(r.window.subarray(a,a+i),n),n+=i,a+=i),e.next_out_index=n,r.read=a,t},r.proc=function(e,i){var c,w,g,y,m,x,k,E;for(y=e.next_in_index,m=e.avail_in,w=r.bitb,g=r.bitk,k=(x=r.write)<r.read?r.read-x-1:r.end-x;;)switch(a){case 0:for(;g<3;){if(0===m)return r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);i=0,m--,w|=(255&e.read_byte(y++))<<g,g+=8}switch(p=1&(c=7&w),c>>>1){case 0:w>>>=3,w>>>=c=7&(g-=3),g-=c,a=1;break;case 1:var S=[],R=[],U=[[]],A=[[]];l.inflate_trees_fixed(S,R,U,A),h.init(S[0],R[0],U[0],0,A[0],0),w>>>=3,g-=3,a=6;break;case 2:w>>>=3,g-=3,a=3;break;case 3:return w>>>=3,g-=3,a=9,e.msg="invalid block type",i=-3,r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i)}break;case 1:for(;g<32;){if(0===m)return r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);i=0,m--,w|=(255&e.read_byte(y++))<<g,g+=8}if((~w>>>16&65535)!=(65535&w))return a=9,e.msg="invalid stored block lengths",i=-3,r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);o=65535&w,w=g=0,a=0!==o?2:0!==p?7:0;break;case 2:if(0===m)return r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);if(0===k&&(x==r.end&&0!==r.read&&(k=(x=0)<r.read?r.read-x-1:r.end-x),0===k&&(r.write=x,i=r.inflate_flush(e,i),k=(x=r.write)<r.read?r.read-x-1:r.end-x,x==r.end&&0!==r.read&&(k=(x=0)<r.read?r.read-x-1:r.end-x),0===k)))return r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);if(i=0,(c=o)>m&&(c=m),c>k&&(c=k),r.window.set(e.read_buf(y,c),x),y+=c,m-=c,x+=c,k-=c,0!=(o-=c))break;a=0!==p?7:0;break;case 3:for(;g<14;){if(0===m)return r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);i=0,m--,w|=(255&e.read_byte(y++))<<g,g+=8}if(s=c=16383&w,(31&c)>29||(c>>5&31)>29)return a=9,e.msg="too many length or distance symbols",i=-3,r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);if(c=258+(31&c)+(c>>5&31),!n||n.length<c)n=[];else for(E=0;E<c;E++)n[E]=0;w>>>=14,g-=14,u=0,a=4;case 4:for(;u<4+(s>>>10);){for(;g<3;){if(0===m)return r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);i=0,m--,w|=(255&e.read_byte(y++))<<g,g+=8}n[f[u++]]=7&w,w>>>=3,g-=3}for(;u<19;)n[f[u++]]=0;if(d[0]=7,0!=(c=v.inflate_trees_bits(n,d,_,b,e)))return-3==(i=c)&&(n=null,a=9),r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);u=0,a=5;case 5:for(;!(u>=258+(31&(c=s))+(c>>5&31));){var I,P;for(c=d[0];g<c;){if(0===m)return r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);i=0,m--,w|=(255&e.read_byte(y++))<<g,g+=8}if(c=b[3*(_[0]+(w&t[c]))+1],(P=b[3*(_[0]+(w&t[c]))+2])<16)w>>>=c,g-=c,n[u++]=P;else{for(E=18==P?7:P-14,I=18==P?11:3;g<c+E;){if(0===m)return r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);i=0,m--,w|=(255&e.read_byte(y++))<<g,g+=8}if(g-=c,I+=(w>>>=c)&t[E],w>>>=E,g-=E,(E=u)+I>258+(31&(c=s))+(c>>5&31)||16==P&&E<1)return n=null,a=9,e.msg="invalid bit length repeat",i=-3,r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);P=16==P?n[E-1]:0;do{n[E++]=P}while(0!=--I);u=E}}_[0]=-1;var D=[],T=[],z=[],O=[];if(D[0]=9,T[0]=6,c=s,0!=(c=v.inflate_trees_dynamic(257+(31&c),1+(c>>5&31),n,D,T,z,O,b,e)))return-3==c&&(n=null,a=9),i=c,r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);h.init(D[0],T[0],b,z[0],b,O[0]),a=6;case 6:if(r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,1!=(i=h.proc(r,e,i)))return r.inflate_flush(e,i);if(i=0,h.free(e),y=e.next_in_index,m=e.avail_in,w=r.bitb,g=r.bitk,k=(x=r.write)<r.read?r.read-x-1:r.end-x,0===p){a=0;break}a=7;case 7:if(r.write=x,i=r.inflate_flush(e,i),k=(x=r.write)<r.read?r.read-x-1:r.end-x,r.read!=r.write)return r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);a=8;case 8:return i=1,r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);case 9:return i=-3,r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i);default:return i=-2,r.bitb=w,r.bitk=g,e.avail_in=m,e.total_in+=y-e.next_in_index,e.next_in_index=y,r.write=x,r.inflate_flush(e,i)}},r.free=function(e){r.reset(e,null),r.window=null,b=null},r.set_dictionary=function(e,t,i){r.window.set(e.subarray(t,t+i),0),r.read=r.write=i},r.sync_point=function(){return 1==a?1:0}}var d=[0,0,255,255];function _(){var e=this;function t(e){return e&&e.istate?(e.total_in=e.total_out=0,e.msg=null,e.istate.mode=7,e.istate.blocks.reset(e,null),0):-2}e.mode=0,e.method=0,e.was=[0],e.need=0,e.marker=0,e.wbits=0,e.inflateEnd=function(t){return e.blocks&&e.blocks.free(t),e.blocks=null,0},e.inflateInit=function(i,n){return i.msg=null,e.blocks=null,n<8||n>15?(e.inflateEnd(i),-2):(e.wbits=n,i.istate.blocks=new u(i,1<<n),t(i),0)},e.inflate=function(e,t){var i,n;if(!e||!e.istate||!e.next_in)return-2;for(t=4==t?-5:0,i=-5;;)switch(e.istate.mode){case 0:if(0===e.avail_in)return i;if(i=t,e.avail_in--,e.total_in++,8!=(15&(e.istate.method=e.read_byte(e.next_in_index++)))){e.istate.mode=13,e.msg="unknown compression method",e.istate.marker=5;break}if(8+(e.istate.method>>4)>e.istate.wbits){e.istate.mode=13,e.msg="invalid window size",e.istate.marker=5;break}e.istate.mode=1;case 1:if(0===e.avail_in)return i;if(i=t,e.avail_in--,e.total_in++,n=255&e.read_byte(e.next_in_index++),((e.istate.method<<8)+n)%31!=0){e.istate.mode=13,e.msg="incorrect header check",e.istate.marker=5;break}if(0==(32&n)){e.istate.mode=7;break}e.istate.mode=2;case 2:if(0===e.avail_in)return i;i=t,e.avail_in--,e.total_in++,e.istate.need=(255&e.read_byte(e.next_in_index++))<<24&4278190080,e.istate.mode=3;case 3:if(0===e.avail_in)return i;i=t,e.avail_in--,e.total_in++,e.istate.need+=(255&e.read_byte(e.next_in_index++))<<16&16711680,e.istate.mode=4;case 4:if(0===e.avail_in)return i;i=t,e.avail_in--,e.total_in++,e.istate.need+=(255&e.read_byte(e.next_in_index++))<<8&65280,e.istate.mode=5;case 5:return 0===e.avail_in?i:(i=t,e.avail_in--,e.total_in++,e.istate.need+=255&e.read_byte(e.next_in_index++),e.istate.mode=6,2);case 6:return e.istate.mode=13,e.msg="need dictionary",e.istate.marker=0,-2;case 7:if(-3==(i=e.istate.blocks.proc(e,i))){e.istate.mode=13,e.istate.marker=0;break}if(0==i&&(i=t),1!=i)return i;i=t,e.istate.blocks.reset(e,e.istate.was),e.istate.mode=12;case 12:return 1;case 13:return-3;default:return-2}},e.inflateSetDictionary=function(e,t,i){var n=0,r=i;return e&&e.istate&&6==e.istate.mode?(r>=1<<e.istate.wbits&&(n=i-(r=(1<<e.istate.wbits)-1)),e.istate.blocks.set_dictionary(t,n,r),e.istate.mode=7,0):-2},e.inflateSync=function(e){var i,n,r,a,o;if(!e||!e.istate)return-2;if(13!=e.istate.mode&&(e.istate.mode=13,e.istate.marker=0),0===(i=e.avail_in))return-5;for(n=e.next_in_index,r=e.istate.marker;0!==i&&r<4;)e.read_byte(n)==d[r]?r++:r=0!==e.read_byte(n)?0:4-r,n++,i--;return e.total_in+=n-e.next_in_index,e.next_in_index=n,e.avail_in=i,e.istate.marker=r,4!=r?-3:(a=e.total_in,o=e.total_out,t(e),e.total_in=a,e.total_out=o,e.istate.mode=7,0)},e.inflateSyncPoint=function(e){return e&&e.istate&&e.istate.blocks?e.istate.blocks.sync_point():-2}}function h(){}h.prototype={inflateInit:function(e){return this.istate=new _,e||(e=15),this.istate.inflateInit(this,e)},inflate:function(e){return this.istate?this.istate.inflate(this,e):-2},inflateEnd:function(){if(!this.istate)return-2;var e=this.istate.inflateEnd(this);return this.istate=null,e},inflateSync:function(){return this.istate?this.istate.inflateSync(this):-2},inflateSetDictionary:function(e,t){return this.istate?this.istate.inflateSetDictionary(this,e,t):-2},read_byte:function(e){return this.next_in.subarray(e,e+1)[0]},read_buf:function(e,t){return this.next_in.subarray(e,e+t)}};var p=e.zip||e;p.Inflater=p._jzlib_Inflater=function(){var e=new h,t=new Uint8Array(512),i=!1;e.inflateInit(),e.next_out=t,this.append=function(n,r){var a,o,s=[],l=0,c=0,f=0;if(0!==n.length){e.next_in_index=0,e.next_in=n,e.avail_in=n.length;do{if(e.next_out_index=0,e.avail_out=512,0!==e.avail_in||i||(e.next_in_index=0,i=!0),a=e.inflate(0),i&&-5===a){if(0!==e.avail_in)throw new Error("inflating: bad input")}else if(0!==a&&1!==a)throw new Error("inflating: "+e.msg);if((i||1===a)&&e.avail_in===n.length)throw new Error("inflating: bad input");e.next_out_index&&(512===e.next_out_index?s.push(new Uint8Array(t)):s.push(new Uint8Array(t.subarray(0,e.next_out_index)))),f+=e.next_out_index,r&&e.next_in_index>0&&e.next_in_index!=l&&(r(e.next_in_index),l=e.next_in_index)}while(e.avail_in>0||0===e.avail_out);return o=new Uint8Array(f),s.forEach((function(e){o.set(e,c),c+=e.length})),o}},this.flush=function(){e.inflateEnd()}}}(this),define("inflate",function(e){return function(){return e.zip}}(this)),define("readium_js_viewer/storage/ZipFileLoader",["zip","../workers/Messages","inflate"],(function(e,t){return e.useWebWorkers=!1,ZipFileLoader=function(e){this.options=e},ZipFileLoader.prototype={init:function(t){if(this.entries)t();else{var i=this.options.buf;this.entries={};var n=this;e.createReader(new e.BlobReader(i),(function(e){e.getEntries((function(e){for(var i=0;i<e.length;i++)e[i].directory||(n.entries[e[i].filename]=e[i]);t()}))}),this.options.error)}},isZipFile:function(){return!0},getZipBlob:function(){return this.options.buf},loadFile:function(t,i){if(!this.entries)throw"you need to call ZipFileLoader.init first";var n=this.entries[t];n?n.getData(new e.BlobWriter,i):i(null)},loadAllFiles:function(t,i,n){if(!this.entries)throw"you need to call ZipFileLoader.init first";for(var r=this.entries,a=0;a<t.length;a++)delete r[t[a]];var o=[],s=function(){o.length&&setTimeout(l.bind(null,o.shift()),0)},l=function(t){t.getData(new e.BlobWriter,n.bind(null,s,t.filename))},c=0,f=this.options.buf.size>157286400?1:200;for(var u in r){var d=r[u];c++<i||(c<=i+f?l(d):o.push(d))}return c}},ZipFileLoader})),define("readium_js_viewer/storage/UnpackedDirLoader",[],(function(){var e=function(e){this.files=e};return e.prototype={isZipFile:function(){return!1},loadFile:function(e,t){t(this.files[e])},loadAllFiles:function(e,t,i){for(var n=0;n<e.length;n++)delete this.files[e[n]];var r=0;for(var a in this.files)r++<t||setTimeout(i.bind(null,null,a,this.files[a]),0);return r}},e})),define("readium_js_viewer/ModuleConfig",["module"],(function(e){var t="";if("undefined"!=typeof window){var i=window.location&&window.location.pathname?window.location.pathname:"";i="/"==(i=i.replace(/(.*)\/.*\.[x]?html$/,"$1")).charAt(i.length-1)?i.substr(0,i.length-1):i,t=window.location?window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+i:""}var n=e.config();return{imagePathPrefix:n.imagePathPrefix||"",epubLibraryPath:n.epubLibraryPath||"epub_content/epub_library.json",canHandleUrl:n.canHandleUrl||!1,canHandleDirectory:n.canHandleDirectory||!1,epubReadingSystemUrl:n.epubReadingSystemUrl||"/EPUBREADINGSYSTEM.js",workerUrl:n.workerUrl||"scripts/readium-js-viewer_CLOUDAPP-WORKER.js",annotationCSSUrl:n.annotationCSSUrl||t+"/css/annotations.css",mathJaxUrl:n.mathJaxUrl||"scripts/mathjax/MathJax.js",jsLibRoot:n.jsLibRoot||"scripts/zip/",fonts:n.fonts||[],useSimpleLoader:n.useSimpleLoader||!1}})),function(e,t){"object"==typeof exports?module.exports=exports=t():"function"==typeof define&&define.amd?define("cryptoJs/core",[],t):e.CryptoJS=t()}(this,(function(){var e=e||function(e,t){var i=Object.create||function(){function e(){}return function(t){var i;return e.prototype=t,i=new e,e.prototype=null,i}}(),n={},r=n.lib={},a=r.Base={extend:function(e){var t=i(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=r.WordArray=a.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||l).stringify(this)},concat:function(e){var t=this.words,i=e.words,n=this.sigBytes,r=e.sigBytes;if(this.clamp(),n%4)for(var a=0;a<r;a++){var o=i[a>>>2]>>>24-a%4*8&255;t[n+a>>>2]|=o<<24-(n+a)%4*8}else for(a=0;a<r;a+=4)t[n+a>>>2]=i[a>>>2];return this.sigBytes+=r,this},clamp:function(){var t=this.words,i=this.sigBytes;t[i>>>2]&=4294967295<<32-i%4*8,t.length=e.ceil(i/4)},clone:function(){var e=a.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var i,n=[],r=function(t){t=t;var i=987654321,n=4294967295;return function(){var r=((i=36969*(65535&i)+(i>>16)&n)<<16)+(t=18e3*(65535&t)+(t>>16)&n)&n;return r/=4294967296,(r+=.5)*(e.random()>.5?1:-1)}},a=0;a<t;a+=4){var s=r(4294967296*(i||e.random()));i=987654071*s(),n.push(4294967296*s()|0)}return new o.init(n,t)}}),s=n.enc={},l=s.Hex={stringify:function(e){for(var t=e.words,i=e.sigBytes,n=[],r=0;r<i;r++){var a=t[r>>>2]>>>24-r%4*8&255;n.push((a>>>4).toString(16)),n.push((15&a).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,i=[],n=0;n<t;n+=2)i[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new o.init(i,t/2)}},c=s.Latin1={stringify:function(e){for(var t=e.words,i=e.sigBytes,n=[],r=0;r<i;r++){var a=t[r>>>2]>>>24-r%4*8&255;n.push(String.fromCharCode(a))}return n.join("")},parse:function(e){for(var t=e.length,i=[],n=0;n<t;n++)i[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new o.init(i,t)}},f=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},u=r.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=f.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var i=this._data,n=i.words,r=i.sigBytes,a=this.blockSize,s=r/(4*a),l=(s=t?e.ceil(s):e.max((0|s)-this._minBufferSize,0))*a,c=e.min(4*l,r);if(l){for(var f=0;f<l;f+=a)this._doProcessBlock(n,f);var u=n.splice(0,l);i.sigBytes-=c}return new o.init(u,c)},clone:function(){var e=a.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),d=(r.Hasher=u.extend({cfg:a.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,i){return new e.init(i).finalize(t)}},_createHmacHelper:function(e){return function(t,i){return new d.HMAC.init(e,i).finalize(t)}}}),n.algo={});return n}(Math);return e})),define("cryptoJs",["cryptoJs/core"],(function(e){return e})),function(e,t){"object"==typeof exports?module.exports=exports=t(require("./core")):"function"==typeof define&&define.amd?define("cryptoJs/sha1",["./core"],t):t(e.CryptoJS)}(this,(function(e){var t,i,n,r,a,o,s;return i=(t=e).lib,n=i.WordArray,r=i.Hasher,a=t.algo,o=[],s=a.SHA1=r.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var i=this._hash.words,n=i[0],r=i[1],a=i[2],s=i[3],l=i[4],c=0;c<80;c++){if(c<16)o[c]=0|e[t+c];else{var f=o[c-3]^o[c-8]^o[c-14]^o[c-16];o[c]=f<<1|f>>>31}var u=(n<<5|n>>>27)+l+o[c];u+=c<20?1518500249+(r&a|~r&s):c<40?1859775393+(r^a^s):c<60?(r&a|r&s|a&s)-1894007588:(r^a^s)-899497514,l=s,s=a,a=r<<30|r>>>2,r=n,n=u}i[0]=i[0]+n|0,i[1]=i[1]+r|0,i[2]=i[2]+a|0,i[3]=i[3]+s|0,i[4]=i[4]+l|0},_doFinalize:function(){var e=this._data,t=e.words,i=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(i/4294967296),t[15+(n+64>>>9<<4)]=i,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}}),t.SHA1=r._createHelper(s),t.HmacSHA1=r._createHmacHelper(s),e.SHA1})),define("readium_js/epub-fetch/encryption_handler",["cryptoJs/sha1"],(function(e){var t=function(e){var t=this,i={"http://www.idpf.org/2008/embedding":function(t,i){n(t,1040,e.uidHash,i)},"http://ns.adobe.com/pdf/enc#RC":function(t,i){var r=function(e){var t=/(urn:uuid:)?([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/i.exec(e),i=t[2]+t[3]+t[4]+t[5]+t[6];i&&32==i.length||console.error("Bad UUID format for ID :"+e);for(var n=[],r=0;r<16;r++){var a=i.substr(2*r,2),o=parseInt(a,16);n.push(o)}return n}(e.uid);n(t,1024,r,i)}};function n(e,t,i,n){!function(e,t){var i=new FileReader;i.onload=function(){var e=this.result;t(new Uint8Array(e))},i.readAsArrayBuffer(e)}(e.slice(0,t),(function(r){for(var a=i.length,o=0;o<t;o++)r[o]=r[o]^i[o%a];var s=new Blob([r],{type:e.type}),l=e.slice(t),c=new Blob([s,l],{type:e.type});n(c)}))}this.isEncryptionSpecified=function(){return e&&e.encryptions},this.getEncryptionMethodForRelativePath=function(i){return t.isEncryptionSpecified()?e.encryptions[i]:void 0},this.getDecryptionFunctionForRelativePath=function(e){var n=t.getEncryptionMethodForRelativePath(e);return n&&i[n]?i[n]:void 0}};return t.CreateEncryptionData=function(t,i){for(var n=unescape(encodeURIComponent(t.trim())),r=e(n),a=[],o=0;o<r.sigBytes;o++)a.push(r.words[o>>>2]>>>24-o%4*8&255);var s={uid:t,uidHash:a,encryptions:void 0};return $("EncryptedData",i).each((function(e,t){var i=$("EncryptionMethod",t).first().attr("Algorithm");$("CipherReference",t).each((function(e,t){var n=$(t).attr("URI");console.log("Encryption/obfuscation algorithm "+i+" specified for "+n),s.encryptions||(s.encryptions={}),s.encryptions[n]=i}))})),s},t})),define("readium_js_viewer/workers/ContentTransformer",["../ModuleConfig","readium_js/epub-fetch/encryption_handler"],(function(e,t){var i=function(e){this.encryptionHandler=new t(e)};return i.prototype={transformContent:function(e,t,i){var n=this.encryptionHandler.getDecryptionFunctionForRelativePath(e);if(n)try{n(t,i)}catch(e){console.error(e),i(t)}else if(function(e){return e.lastIndexOf(".xhtml")==e.length-".xhtml".length||e.lastIndexOf(".html")==e.length-".html".length}(e)){var r=new FileReader,a=this;r.onload=function(){var e=a._transformXhtml(this.result);i(new Blob([e]))},r.readAsText(t)}else i(t)},_transformXhtml:function(t){var i=e.mathJaxUrl,n=e.epubReadingSystemUrl,r="";return n&&(r+='<script type="text/javascript" src="'+n+'"><\/script>'),i&&t.search(/<(\w+:|)(?=math)/)>=0&&(r+='<script type="text/javascript" src="'+i+'"><\/script>'),r?t.replace(/(<head[\s\S]*?>)/,"$1"+r):t}},i})),define("readium_js_viewer/workers/CloudLibraryWriter",["StorageManager","../storage/ZipFileLoader","../storage/UnpackedDirLoader","./Messages","./ContentTransformer"],(function(e,t,i,n,r){var a=function(){};a.prototype={_getFullUrl:function(e,t){if(!t)return null;var i=e.split("/");return i.pop(),i.join("/")+("/"==t.charAt(0)?"":"/")+t},_saveLibraryIndex:function(t,i,n){for(var r=n.length;r--;)void 0===n[r].id&&n.splice(r,1);e.saveBookshelf("db://epub_library.json",n,t,i)},_saveEpubToIndex:function(t,i){var r=this;postMessage({msg:n.STORE_TEMP_BOOKSHELF,epubObj:i}),e.getFile("db://epub_library.json",(function(e){var n=[];e&&(n=e),n.push(i),Array.prototype.push.apply(r.libraryData,n),r._saveLibraryIndex((function(){t.success(i)}),t.error,n)}),(function(){console.log("error getting epub_content")}))},_addEpub:function(t,i,n,r){var a=this.fileLoader,o=a.getZipBlob(),s=o.name,l=this,c=function(){console.log("package: "),console.log(JSON.stringify(i,null,4)),console.log("packagePath: "+n);var r={id:i.id,rootDir:s,packagePath:n,title:i.title,author:i.author,rootUrl:e.getPathUrl(s)};i.coverHref&&(r.coverPath=i.coverHref,r.coverHref=e.getPathUrl(s+"/"+l._getFullUrl(n,i.coverHref))),l._saveEpubToIndex(t,r)};e.saveFile("db://"+s,o,(function(){a.loadFile("OEBPS/"+i.coverHref,(function(t){e.saveFile("db://"+s+"/OEBPS/"+i.coverHref,t,c,(function(e){console.log(e)}))}))}),(function(e){console.log(e)}))},_replaceEpub:function(e,t,i){var n=this,r={success:function(t){n.deleteEpub(e,(function(){n.callbacks.success(t)}),n.callbacks.error)},error:this.callbacks.error,progress:this.callbacks.progress};this._addEpub(r,t,i)},_checkForConflict:function(e,t,i){for(var n=0;n<this.libraryData.length;n++)if(this.libraryData[n].id===e.id){var r=this._replaceEpub.bind(this,this.libraryData[n],e,t),a=this._addEpub.bind(this,this.callbacks,e,t);return void this.callbacks.overwrite(this.libraryData[n],r,a)}this._addEpub(this.callbacks,e,t,i)},_deleteEpubWithIndex:function(t,i,n){var r=this.libraryData[t];this.libraryData.splice(t,1),this._saveLibraryIndex((function(){e.deleteFile(r.rootDir,i,n)}),n)},_loadFileAsString:function(e,t,i){var r=this.callbacks.error,a=new FileReader;this.fileLoader.loadFile(e,(function(o){o?(a.onload=function(){t(this.result)},a.readAsText(o)):i?t(void 0):(r(n.ERROR_EPUB),console.error("Epub archive or directory missing a required  file: "+e))}))},_findPackagePath:function(e,t){l=function(e){l=null,t(e.path)},postMessage({msg:n.FIND_PACKAGE,containerStr:e})},_parsePackageData:function(e,t,i){c=function(e){c=null,i(e.packageObj,e.encryptionData)},postMessage({msg:n.PARSE_PACKAGE,packageStr:e,encryptionStr:t})},_addEpubToLibrary:function(e){this.fileLoader=e;var t=this;this._loadFileAsString("META-INF/container.xml",(function(e){t._findPackagePath(e,(function(e){t._loadFileAsString(e,(function(i){t._loadFileAsString("META-INF/encryption.xml",(function(n){t._parsePackageData(i,n,(function(i,n){t._checkForConflict(i,e,n)}))}),!0)}))}))}))},deleteEpubWithId:function(e,t,i){for(var n=0;n<this.libraryData.length&&this.libraryData[n].rootDir!=e;n++);n<this.libraryData.length?this._deleteEpubWithIndex(n,t,i):t()},deleteEpub:function(e,t,i){for(var n=0;n<this.libraryData.length&&this.libraryData[n]!=e;n++);n<this.libraryData.length?this._deleteEpubWithIndex(n,t,i):t()},importZip:function(e,i){this.callbacks=i;var n=new t({buf:e,error:i.error});n.init(this._addEpubToLibrary.bind(this,n))},continueImportZip:function(e,i,n,r){this.callbacks=r,this.startAtIndex=i,this.rootDirName=n;var a=new t({buf:e,error:r.error});this._addEpubToLibrary(a)},importFileList:function(e,t){this.callbacks=t,this._addEpubToLibrary(new i(e))},importUrl:function(e,t){var i=new XMLHttpRequest;self=this,error=function(){t.error(n.ERROR_AJAX)},i.open("GET",e,!0),i.responseType="blob",i.onload=function(e){if(200==this.status){var i=new Blob([this.response],{type:"application/epub"});self.importZip(i,t)}else error()},i.onerror=error,i.send()}};var o,s,l,c,f=new a;return onmessage=function(t){var i=t.data,r=i.msg,a=function(){postMessage({msg:n.SUCCESS,libraryItems:f.libraryData})},u=function(e,t,i){postMessage({msg:n.PROGRESS,percent:e,progressType:t,progressData:i})},d=function(e,t){postMessage({msg:n.ERROR,errorMsg:e,errorData:t})},_=function(e,t,i){postMessage({msg:n.CONTINUE_IMPORT_ZIP,buf:e,index:t,rootDirName:i,libraryItems:f.libraryData})},h=function(e,t,i){postMessage({msg:n.OVERWRITE,item:e}),o=function(){o=null,s=null,t()},s=function(){o=null,s=null,i()}};switch(r){case n.IMPORT_ZIP:f.libraryData=i.libraryItems;var p=i.buf;e.initStorage((function(){f.importZip(p,{success:a,progress:u,error:d,overwrite:h,continueImport:_})}),d);break;case n.CONTINUE_IMPORT_ZIP:f.libraryData=i.libraryItems;p=i.buf;var b=i.index,v=i.rootDirName;e.initStorage((function(){f.continueImportZip(p,b,v,{success:a,progress:u,error:d,overwrite:h,continueImport:_})}),d);break;case n.DELETE_EPUB:f.libraryData=i.libraryItems;var w=i.id;e.initStorage((function(){f.deleteEpubWithId(w,a,d)}),d);break;case n.IMPORT_DIR:f.libraryData=i.libraryItems;var g=i.files;e.initStorage((function(){f.importFileList(g,{success:a,progress:u,error:d,overwrite:h})}),d);break;case n.IMPORT_URL:f.libraryData=i.libraryItems;var y=i.url;e.initStorage((function(){f.importUrl(y,{success:a,progress:u,error:d,overwrite:h})}),d);break;case n.MIGRATE:e.initStorage((function(){e.migrateLegacyBooks(a,d,(function(e,t){u(e,n.PROGRESS_MIGRATING,t)}))}),d);case n.OVERWRITE_CONTINUE:o&&o(i);break;case n.OVERWRITE_SIDE_BY_SIDE:s&&s(i);break;case n.FIND_PACKAGE_RESPONSE:l&&l(i);break;case n.PARSE_PACKAGE_RESPONSE:c&&c(i)}},setTimeout((function(){postMessage({msg:n.READY})}),30),f})),require(["readium_js_viewer/workers/CloudLibraryWriter"]);